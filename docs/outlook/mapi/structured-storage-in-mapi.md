---
title: MAPI での構造化ストレージ
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: '�ŏI�X�V��: 2015�N3��9��'
ms.openlocfilehash: 462ee84d5e9acd26f80bae6516179f21651749be
ms.sourcegitcommit: 9d60cd82b5413446e5bc8ace2cd689f683fb41a7
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/11/2018
ms.locfileid: "19804041"
---
# <a name="structured-storage-in-mapi"></a><span data-ttu-id="b4164-103">MAPI での構造化ストレージ</span><span class="sxs-lookup"><span data-stu-id="b4164-103">Structured Storage in MAPI</span></span>

  
  
<span data-ttu-id="b4164-104">**適用されます**: Outlook</span><span class="sxs-lookup"><span data-stu-id="b4164-104">**Applies to**: Outlook</span></span> 
  
<span data-ttu-id="b4164-105">COM で導入されたストレージの階層的な組織には、構造化ストレージ</span><span class="sxs-lookup"><span data-stu-id="b4164-105">Structured storage refers to the hierarchical organization of storage introduced with COM.</span></span> <span data-ttu-id="b4164-106">構造化ストレージ環境でのオブジェクトの 2 つまたは 3 つのタイプにストレージが構成されています。</span><span class="sxs-lookup"><span data-stu-id="b4164-106">In a structured storage environment, storage is organized into two or three types of objects:</span></span> 
  
- <span data-ttu-id="b4164-107">ストリーム オブジェクト</span><span class="sxs-lookup"><span data-stu-id="b4164-107">Stream objects</span></span>
    
- <span data-ttu-id="b4164-108">バイトのオブジェクトをロック</span><span class="sxs-lookup"><span data-stu-id="b4164-108">Lock bytes objects</span></span>
    
- <span data-ttu-id="b4164-109">ストレージ オブジェクト</span><span class="sxs-lookup"><span data-stu-id="b4164-109">Storage objects</span></span>
    
<span data-ttu-id="b4164-110">バイトのストリームとロックは、データに直接アクセスする下位のオブジェクトです。</span><span class="sxs-lookup"><span data-stu-id="b4164-110">Stream and lock bytes are lower-level objects that directly access the data.</span></span> <span data-ttu-id="b4164-111">ストリーム オブジェクトは、読み取り、作成、配置、およびデータのバイト数をコピーするメソッドを定義する**IStream**インターフェイスを実装します。</span><span class="sxs-lookup"><span data-stu-id="b4164-111">Stream objects implement the **IStream** interface which defines methods for reading, writing, positioning, and copying bytes of data.</span></span> <span data-ttu-id="b4164-112">**ILockBytes**、バイト配列を使用してデータにアクセスするのには、別の COM インターフェイスを実装するバイトのオブジェクトをロックします。</span><span class="sxs-lookup"><span data-stu-id="b4164-112">Lock bytes objects implement another COM interface, **ILockBytes**, to access data with a byte array.</span></span> <span data-ttu-id="b4164-113">バイト配列は、基になるストレージのカスタマイズされたアクセスを提供する通常使用されます。</span><span class="sxs-lookup"><span data-stu-id="b4164-113">Byte arrays are typically used to provide customized access to underlying storage.</span></span>
  
<span data-ttu-id="b4164-114">ストレージ オブジェクトは、オブジェクトの上に、ストリームまたはロック バイトは階層化されています。その他のストレージ ・ オブジェクトと同様にこれらのオブジェクトの 1 つ以上含まれていることができます。</span><span class="sxs-lookup"><span data-stu-id="b4164-114">Storage objects are layered on top of the stream or lock bytes objects; they can contain one or more of these objects as well as other storage objects.</span></span> <span data-ttu-id="b4164-115">ストレージ オブジェクトは、作成、アクセス、および入れ子になったオブジェクトを維持するためのメソッドを定義する**IStorage**インターフェイスを実装します。</span><span class="sxs-lookup"><span data-stu-id="b4164-115">Storage objects implement the **IStorage** interface which defines methods for creating, accessing, and maintaining nested objects.</span></span> 
  
<span data-ttu-id="b4164-116">**IStream** **ILockBytes**、 **IStorage** MAPI インターフェイスではなく、COM インターフェイスであるため、メソッドは、MAPI の値ではなく、COM エラー値を返します。</span><span class="sxs-lookup"><span data-stu-id="b4164-116">Because **IStream**, **ILockBytes**, and **IStorage** are COM interfaces rather than MAPI interfaces, their methods return COM error values rather than MAPI values.</span></span> <span data-ttu-id="b4164-117">クライアントとサービス プロバイダーがこれらのインターフェイスでメソッドを呼び出すことは、MAPI エラーの値にこれらの値を変換するため、API 関数**MapStorageSCode**を使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b4164-117">Clients and service providers calling methods in these interfaces must use the API function **MapStorageSCode** to translate these values into MAPI error values.</span></span> <span data-ttu-id="b4164-118">詳細については、 [MapStorageSCode](mapstoragescode.md)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b4164-118">For more information, see [MapStorageSCode](mapstoragescode.md).</span></span>
  
<span data-ttu-id="b4164-119">クライアントとサービス ・ プロバイダーが大きすぎて**IMAPIProp**メソッド、通常は大量の文字列、およびバイナリのプロパティを維持するプロパティを操作する構造化ストレージを使用します。</span><span class="sxs-lookup"><span data-stu-id="b4164-119">Clients and service providers use structured storage for working with properties that are too large to maintain with the **IMAPIProp** methods, typically large string and binary properties.</span></span> <span data-ttu-id="b4164-120">**IStream**または**IStorage**を指定する[IMAPIProp::OpenProperty](imapiprop-openproperty.md)メソッドへの呼び出しのインターフェイス識別子として、クライアントまたはサービス プロバイダーにアクセスする一般的な方法の 1 つです。</span><span class="sxs-lookup"><span data-stu-id="b4164-120">One of the common ways that clients or service providers access them is by specifying **IStream** or **IStorage** as the interface identifier in a call to the [IMAPIProp::OpenProperty](imapiprop-openproperty.md) method.</span></span> <span data-ttu-id="b4164-121">たとえば、クライアントでは、プロパティ タグとメッセージでバイナリ添付ファイルにアクセスするためのインタ フェース id として IID_IStream として**PR_ATTACH_DATA_BIN**を**OpenProperty**を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b4164-121">For example, clients call **OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag and IID_IStream as the interface identifier to access a binary attachment in a message.</span></span> 
  
<span data-ttu-id="b4164-122">クライアントとサービス ・ プロバイダーを独自のストリームと記憶域オブジェクトを実装または MAPI または COM によって提供されるアクセスの実装に API 関数を呼び出す</span><span class="sxs-lookup"><span data-stu-id="b4164-122">Clients and service providers can implement their own stream and storage objects or call API functions to access implementations supplied by MAPI or COM.</span></span> <span data-ttu-id="b4164-123">指定の実装には、ほとんどの目的がため、クライアントとサービスのプロバイダーはほとんどありません必要がありますが独自に作成します。</span><span class="sxs-lookup"><span data-stu-id="b4164-123">Because the supplied implementations serve most purposes, clients and service providers rarely need to create their own.</span></span> 
  
<span data-ttu-id="b4164-124">時、クライアントの呼び出し**OpenProperty** MAPI オブジェクトのストレージ オブジェクトをいずれかのプロパティにアクセスするのには、サービス プロバイダーは通常起動されているダイレクト モードのストレージ オブジェクトを使用します。</span><span class="sxs-lookup"><span data-stu-id="b4164-124">When a client calls **OpenProperty** on a MAPI object to access one of its properties through a storage object, the service provider will typically open the storage object in direct mode.</span></span> <span data-ttu-id="b4164-125">ただし、これは、必要な動作ではなく一般的です。</span><span class="sxs-lookup"><span data-stu-id="b4164-125">However, this is typical rather than required behavior.</span></span> <span data-ttu-id="b4164-126">開く、またはサービス プロバイダーによって作成されたすべてのストレージ ・ オブジェクトがトランザクション処理を行うし、 **IStorage::Commit**への呼び出しを必要とするクライアントを想定してください。</span><span class="sxs-lookup"><span data-stu-id="b4164-126">Clients should assume that all storage objects opened or created by service providers are transacted and require a call to **IStorage::Commit**.</span></span> <span data-ttu-id="b4164-127">ストレージ オブジェクトへの変更ない行われること永続的な最終的な**コミット**を MAPI オブジェクトを保存した後は**IMAPIProp::SaveChanges**を呼び出すまでも覚えてください。</span><span class="sxs-lookup"><span data-stu-id="b4164-127">They should also remember that changes to storage objects will not be made permanent until they call **IMAPIProp::SaveChanges** after the final **Commit** to save the MAPI object.</span></span> <span data-ttu-id="b4164-128">詳細については、 [IMAPIProp::SaveChanges](imapiprop-savechanges.md)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b4164-128">For more information, see [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span></span>
  
<span data-ttu-id="b4164-129">MAPI と COM は、いくつかの API 関数を定義することや、ストレージとストリーム オブジェクトへのアクセスを提供します。</span><span class="sxs-lookup"><span data-stu-id="b4164-129">MAPI and COM provide several API functions for defining or accessing storage and stream objects.</span></span> <span data-ttu-id="b4164-130">一般的に使用される関数は、次の表で説明します。</span><span class="sxs-lookup"><span data-stu-id="b4164-130">The commonly used functions are described in the following table.</span></span>
  
<span data-ttu-id="b4164-131">**ストレージおよびストリーム オブジェクトにアクセスするための関数**</span><span class="sxs-lookup"><span data-stu-id="b4164-131">**Functions for Accessing Storage and Stream Objects**</span></span>

|<span data-ttu-id="b4164-132">**関数**</span><span class="sxs-lookup"><span data-stu-id="b4164-132">**Function**</span></span>|<span data-ttu-id="b4164-133">**説明**</span><span class="sxs-lookup"><span data-stu-id="b4164-133">**Description**</span></span>|
|:-----|:-----|
|[<span data-ttu-id="b4164-134">HrIStorageFromStream</span><span class="sxs-lookup"><span data-stu-id="b4164-134">HrIStorageFromStream</span></span>](hristoragefromstream.md) <br/> |<span data-ttu-id="b4164-135">バイト ストリームまたはロック オブジェクトにアクセスするストレージ オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="b4164-135">Creates a storage object to access a stream or lock bytes object.</span></span>  <br/> |
|[<span data-ttu-id="b4164-136">OpenIMsgOnIStg</span><span class="sxs-lookup"><span data-stu-id="b4164-136">OpenIMsgOnIStg</span></span>](openimsgonistg.md) <br/> |<span data-ttu-id="b4164-137">ストレージ ・ オブジェクトにアクセスするためのメッセージ オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="b4164-137">Creates a message object to access a storage object.</span></span>  <br/> |
|[<span data-ttu-id="b4164-138">OpenStreamOnFile</span><span class="sxs-lookup"><span data-stu-id="b4164-138">OpenStreamOnFile</span></span>](openstreamonfile.md) <br/> |<span data-ttu-id="b4164-139">ファイルにアクセスするためのストリーム オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="b4164-139">Creates a stream object to access a file.</span></span>  <br/> |
|[<span data-ttu-id="b4164-140">WrapCompressedRTFStream</span><span class="sxs-lookup"><span data-stu-id="b4164-140">WrapCompressedRTFStream</span></span>](wrapcompressedrtfstream.md) <br/> |<span data-ttu-id="b4164-141">メッセージのリッチ テキストを保持しているストリームの圧縮または非圧縮バージョンを格納するストリーム オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="b4164-141">Creates a stream object that contains the compressed or uncompressed version of a stream holding the rich text of a message.</span></span>  <br/> |
   
 <span data-ttu-id="b4164-142">**指定されたサブストレージにストリームの名前を取得するには**</span><span class="sxs-lookup"><span data-stu-id="b4164-142">**To retrieve the names of the streams in a given substorage**</span></span>
  
1. <span data-ttu-id="b4164-143">**IEnumSTATSTG**インタ フェースを取得するのには、サブストレージの**IStorage::EnumElements**メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b4164-143">Call the substorage's **IStorage::EnumElements** method to get an **IEnumSTATSTG** interface.</span></span> 
    
2. <span data-ttu-id="b4164-144">呼び出す**IEnumSTATSTG::Next** **STATSTG**構造体の多くを同時にすることができます。</span><span class="sxs-lookup"><span data-stu-id="b4164-144">Call **IEnumSTATSTG::Next** with as many **STATSTG** structures at a time as you can.</span></span> <span data-ttu-id="b4164-145">同時に 100 を依頼する場合**次**通常を返します S_FALSE_内_の内容が実際に取得された番号に設定します。</span><span class="sxs-lookup"><span data-stu-id="b4164-145">If you ask for 100 at a time, **Next** will usually return S_FALSE with the contents of  _pceltFetched_ set to the number that were actually retrieved.</span></span> 
    
3. <span data-ttu-id="b4164-146">STGTY_STREAM のフラグが設定されている**STATSTG**構造体を確認します。</span><span class="sxs-lookup"><span data-stu-id="b4164-146">Check for the **STATSTG** structures that are flagged with STGTY_STREAM.</span></span> 
    
4. <span data-ttu-id="b4164-147">_PwcsName_パラメーターを解放します。</span><span class="sxs-lookup"><span data-stu-id="b4164-147">Release the  _pwcsName_ parameter.</span></span> 
    
 <span data-ttu-id="b4164-148">**ストリームまたはロック バイトの既存オブジェクトにアクセスするストレージ ・ オブジェクトを作成するには**</span><span class="sxs-lookup"><span data-stu-id="b4164-148">**To create a storage object to access an existing stream or lock bytes object**</span></span>
  
- <span data-ttu-id="b4164-149">クライアントは、 [HrIStorageFromStream](hristoragefromstream.md)を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b4164-149">Clients call [HrIStorageFromStream](hristoragefromstream.md).</span></span> 
    
 <span data-ttu-id="b4164-150">**既存のストレージ ・ オブジェクトにアクセスするためのメッセージ オブジェクトを作成するには**</span><span class="sxs-lookup"><span data-stu-id="b4164-150">**To create a message object to access an existing storage object**</span></span>
  
- <span data-ttu-id="b4164-151">サービス プロバイダーとクライアントは、 [OpenIMsgOnIStg](openimsgonistg.md)を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b4164-151">Service providers and clients call [OpenIMsgOnIStg](openimsgonistg.md).</span></span> <span data-ttu-id="b4164-152">通常メッセージ ストア プロバイダーによって作成をサポートしていないすべての点でメッセージのオブジェクトとは異なるメッセージ オブジェクトが作成される、 [IMessage: IMAPIProp](imessageimapiprop.md)インターフェイスのメソッドは、 **IMessage::SubmitMessage**などです。</span><span class="sxs-lookup"><span data-stu-id="b4164-152">The message object that is created differs from the message objects typically created by message store providers in that it does not support all of the [IMessage : IMAPIProp](imessageimapiprop.md) interface methods, such as **IMessage::SubmitMessage**.</span></span> <span data-ttu-id="b4164-153">**OpenIMsgOnIStg**にオプションの入力パラメーターは、 [MSGCALLRELEASE](msgcallrelease.md)のプロトタイプに準拠するコールバック関数です。</span><span class="sxs-lookup"><span data-stu-id="b4164-153">An optional input parameter to **OpenIMsgOnIStg** is a callback function that conforms to the [MSGCALLRELEASE](msgcallrelease.md) prototype.</span></span> <span data-ttu-id="b4164-154">メッセージの参照カウントが 0 になったとき、新しいメッセージ オブジェクトがこの関数が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="b4164-154">This function is called by the new message object when the message's reference count reaches zero.</span></span> <span data-ttu-id="b4164-155">**MSGCALLRELEASE**関数を実装すると、新しいメッセージを完全に削除する前に、最終的な処理を実行するのに役立つことができます。</span><span class="sxs-lookup"><span data-stu-id="b4164-155">Implementing a **MSGCALLRELEASE** function can be useful for performing final processing before the new message is completely removed.</span></span> 
    
<span data-ttu-id="b4164-156">[OpenStreamOnFile](openstreamonfile.md)は通常、ファイルを読み書きするストリームを作成するので、ファイルの添付ファイルを格納するため使用されます。</span><span class="sxs-lookup"><span data-stu-id="b4164-156">[OpenStreamOnFile](openstreamonfile.md) is commonly used for storing file attachments because it creates a stream that reads from and writes to a file.</span></span> <span data-ttu-id="b4164-157">プロパティ タグとして**PR_ATTACH_DATA_BIN**を**OpenProperty**では、バイナリ添付ファイルデータを格納するためのストリームを作成します。</span><span class="sxs-lookup"><span data-stu-id="b4164-157">**OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag creates a stream for storing binary attachment data.</span></span> 
  
 <span data-ttu-id="b4164-158">**圧縮またはリッチ テキスト形式でメッセージのテキストを格納しているストリームを圧縮解除するには**</span><span class="sxs-lookup"><span data-stu-id="b4164-158">**To compress or uncompress a stream containing message text in the Rich Text Format**</span></span>
  
- <span data-ttu-id="b4164-159">クライアントは、 [WrapCompressedRTFStream](wrapcompressedrtfstream.md)を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b4164-159">Clients call [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span></span> <span data-ttu-id="b4164-160">**WrapCompressedRTFStream**は、rtf 形式のストリームをラップするストリームを作成します。</span><span class="sxs-lookup"><span data-stu-id="b4164-160">**WrapCompressedRTFStream** creates a stream that wraps the RTF stream.</span></span> <span data-ttu-id="b4164-161">**IStream**メソッドのラッパーのストリームを実装しません次のメソッドが除外されます:**シーク**、 **SetSize**、**元に戻す**、 **LockRegion**、 **UnlockRegion**、**統計**、および**クローン**です。</span><span class="sxs-lookup"><span data-stu-id="b4164-161">The wrapper stream does not implement all of the **IStream** methods; the following methods are excluded: **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat**, and **Clone**.</span></span> <span data-ttu-id="b4164-162">これは、 **WrapCompressedRTFStream**によって作成されたストリーム オブジェクトでは、 **SetSize**または**Stat**のいずれかがサポートされないため、または拡張のいずれかのサイズを取得する簡単な方法がありません。</span><span class="sxs-lookup"><span data-stu-id="b4164-162">This is because the stream objects created by **WrapCompressedRTFStream** do not support either **SetSize** or **Stat**, there is not an easy way to either extend or retrieve their size.</span></span> <span data-ttu-id="b4164-163">最善の戦略では、適切なバッファー サイズを選択し、読み取りまたはループ内で書き込みをします。</span><span class="sxs-lookup"><span data-stu-id="b4164-163">The best strategy is to pick a reasonable buffer size and read or write in a loop.</span></span>
    
> [!NOTE]
> <span data-ttu-id="b4164-164">COM は、問題のある、 **EnumElements**メソッドからの**IEnumSTATSTG**オブジェクトを表すバイト配列に基づいて、ストレージ ・ オブジェクトの実装を持ちます。</span><span class="sxs-lookup"><span data-stu-id="b4164-164">COM has a storage object implementation based on a byte array that returns an **IEnumSTATSTG** object from the **EnumElements** method that is problematic.</span></span> <span data-ttu-id="b4164-165">特に、 **QueryInterface**メソッドが正常に機能しません。</span><span class="sxs-lookup"><span data-stu-id="b4164-165">In particular, the **QueryInterface** method does not work correctly.</span></span> <span data-ttu-id="b4164-166">COM の実装を使用して独自のストレージ オブジェクトを実装するサービス プロバイダーを作成します**IEnumSTATSTG**オブジェクトの基になる**IEnumSTATSTG**メソッドに呼び出しを転送するが、実装のシン ラッパー独自**AddRef**、**リリース**、**バージョン管理規則によって**、および**クローン**の方法です。</span><span class="sxs-lookup"><span data-stu-id="b4164-166">Service providers that implement their own storage objects using the COM implementation should create a thin wrapper for the **IEnumSTATSTG** object that forwards calls on to the underlying **IEnumSTATSTG** methods but implements its own **AddRef**, **Release**, **QueryInterface**, and **Clone** methods.</span></span> 
  

