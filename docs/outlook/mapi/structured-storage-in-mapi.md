---
title: MAPI での構造化ストレージ
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: '最終更新日時: 2015 年 3 月 9 日'
ms.openlocfilehash: 462ee84d5e9acd26f80bae6516179f21651749be
ms.sourcegitcommit: 9d60cd82b5413446e5bc8ace2cd689f683fb41a7
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/11/2018
ms.locfileid: "19804041"
---
# <a name="structured-storage-in-mapi"></a>MAPI での構造化ストレージ

  
  
**適用対象**: Outlook 
  
COM で導入されたストレージの階層的な組織には、構造化ストレージ 構造化ストレージ環境でのオブジェクトの 2 つまたは 3 つのタイプにストレージが構成されています。 
  
- ストリーム オブジェクト
    
- バイトのオブジェクトをロック
    
- ストレージ オブジェクト
    
バイトのストリームとロックは、データに直接アクセスする下位のオブジェクトです。 ストリーム オブジェクトは、読み取り、作成、配置、およびデータのバイト数をコピーするメソッドを定義する**IStream**インターフェイスを実装します。 **ILockBytes**、バイト配列を使用してデータにアクセスするのには、別の COM インターフェイスを実装するバイトのオブジェクトをロックします。 バイト配列は、基になるストレージのカスタマイズされたアクセスを提供する通常使用されます。
  
ストレージ オブジェクトは、オブジェクトの上に、ストリームまたはロック バイトは階層化されています。その他のストレージ ・ オブジェクトと同様にこれらのオブジェクトの 1 つ以上含まれていることができます。 ストレージ オブジェクトは、作成、アクセス、および入れ子になったオブジェクトを維持するためのメソッドを定義する**IStorage**インターフェイスを実装します。 
  
**IStream** **ILockBytes**、 **IStorage** MAPI インターフェイスではなく、COM インターフェイスであるため、メソッドは、MAPI の値ではなく、COM エラー値を返します。 クライアントとサービス プロバイダーがこれらのインターフェイスでメソッドを呼び出すことは、MAPI エラーの値にこれらの値を変換するため、API 関数**MapStorageSCode**を使用する必要があります。 詳細については、 [MapStorageSCode](mapstoragescode.md)を参照してください。
  
クライアントとサービス ・ プロバイダーが大きすぎて**IMAPIProp**メソッド、通常は大量の文字列、およびバイナリのプロパティを維持するプロパティを操作する構造化ストレージを使用します。 **IStream**または**IStorage**を指定する[IMAPIProp::OpenProperty](imapiprop-openproperty.md)メソッドへの呼び出しのインターフェイス識別子として、クライアントまたはサービス プロバイダーにアクセスする一般的な方法の 1 つです。 たとえば、クライアントでは、プロパティ タグとメッセージでバイナリ添付ファイルにアクセスするためのインタ フェース id として IID_IStream として**PR_ATTACH_DATA_BIN**を**OpenProperty**を呼び出します。 
  
クライアントとサービス ・ プロバイダーを独自のストリームと記憶域オブジェクトを実装または MAPI または COM によって提供されるアクセスの実装に API 関数を呼び出す 指定の実装には、ほとんどの目的がため、クライアントとサービスのプロバイダーはほとんどありません必要がありますが独自に作成します。 
  
時、クライアントの呼び出し**OpenProperty** MAPI オブジェクトのストレージ オブジェクトをいずれかのプロパティにアクセスするのには、サービス プロバイダーは通常起動されているダイレクト モードのストレージ オブジェクトを使用します。 ただし、これは、必要な動作ではなく一般的です。 開く、またはサービス プロバイダーによって作成されたすべてのストレージ ・ オブジェクトがトランザクション処理を行うし、 **IStorage::Commit**への呼び出しを必要とするクライアントを想定してください。 ストレージ オブジェクトへの変更ない行われること永続的な最終的な**コミット**を MAPI オブジェクトを保存した後は**IMAPIProp::SaveChanges**を呼び出すまでも覚えてください。 詳細については、 [IMAPIProp::SaveChanges](imapiprop-savechanges.md)を参照してください。
  
MAPI と COM は、いくつかの API 関数を定義することや、ストレージとストリーム オブジェクトへのアクセスを提供します。 一般的に使用される関数は、次の表で説明します。
  
**ストレージおよびストリーム オブジェクトにアクセスするための関数**

|**関数**|**説明**|
|:-----|:-----|
|[HrIStorageFromStream](hristoragefromstream.md) <br/> |バイト ストリームまたはロック オブジェクトにアクセスするストレージ オブジェクトを作成します。  <br/> |
|[OpenIMsgOnIStg](openimsgonistg.md) <br/> |ストレージ ・ オブジェクトにアクセスするためのメッセージ オブジェクトを作成します。  <br/> |
|[OpenStreamOnFile](openstreamonfile.md) <br/> |ファイルにアクセスするためのストリーム オブジェクトを作成します。  <br/> |
|[WrapCompressedRTFStream](wrapcompressedrtfstream.md) <br/> |メッセージのリッチ テキストを保持しているストリームの圧縮または非圧縮バージョンを格納するストリーム オブジェクトを作成します。  <br/> |
   
 **指定されたサブストレージにストリームの名前を取得するには**
  
1. **IEnumSTATSTG**インタ フェースを取得するのには、サブストレージの**IStorage::EnumElements**メソッドを呼び出します。 
    
2. 呼び出す**IEnumSTATSTG::Next** **STATSTG**構造体の多くを同時にすることができます。 同時に 100 を依頼する場合**次**通常を返します S_FALSE_内_の内容が実際に取得された番号に設定します。 
    
3. STGTY_STREAM のフラグが設定されている**STATSTG**構造体を確認します。 
    
4. _PwcsName_パラメーターを解放します。 
    
 **ストリームまたはロック バイトの既存オブジェクトにアクセスするストレージ ・ オブジェクトを作成するには**
  
- クライアントは、 [HrIStorageFromStream](hristoragefromstream.md)を呼び出します。 
    
 **既存のストレージ ・ オブジェクトにアクセスするためのメッセージ オブジェクトを作成するには**
  
- サービス プロバイダーとクライアントは、 [OpenIMsgOnIStg](openimsgonistg.md)を呼び出します。 通常メッセージ ストア プロバイダーによって作成をサポートしていないすべての点でメッセージのオブジェクトとは異なるメッセージ オブジェクトが作成される、 [IMessage: IMAPIProp](imessageimapiprop.md)インターフェイスのメソッドは、 **IMessage::SubmitMessage**などです。 **OpenIMsgOnIStg**にオプションの入力パラメーターは、 [MSGCALLRELEASE](msgcallrelease.md)のプロトタイプに準拠するコールバック関数です。 メッセージの参照カウントが 0 になったとき、新しいメッセージ オブジェクトがこの関数が呼び出されます。 **MSGCALLRELEASE**関数を実装すると、新しいメッセージを完全に削除する前に、最終的な処理を実行するのに役立つことができます。 
    
[OpenStreamOnFile](openstreamonfile.md)は通常、ファイルを読み書きするストリームを作成するので、ファイルの添付ファイルを格納するため使用されます。 プロパティ タグとして**PR_ATTACH_DATA_BIN**を**OpenProperty**では、バイナリ添付ファイルデータを格納するためのストリームを作成します。 
  
 **圧縮またはリッチ テキスト形式でメッセージのテキストを格納しているストリームを圧縮解除するには**
  
- クライアントは、 [WrapCompressedRTFStream](wrapcompressedrtfstream.md)を呼び出します。 **WrapCompressedRTFStream**は、rtf 形式のストリームをラップするストリームを作成します。 **IStream**メソッドのラッパーのストリームを実装しません次のメソッドが除外されます:**シーク**、 **SetSize**、**元に戻す**、 **LockRegion**、 **UnlockRegion**、**統計**、および**クローン**です。 これは、 **WrapCompressedRTFStream**によって作成されたストリーム オブジェクトでは、 **SetSize**または**Stat**のいずれかがサポートされないため、または拡張のいずれかのサイズを取得する簡単な方法がありません。 最善の戦略では、適切なバッファー サイズを選択し、読み取りまたはループ内で書き込みをします。
    
> [!NOTE]
> COM は、問題のある、 **EnumElements**メソッドからの**IEnumSTATSTG**オブジェクトを表すバイト配列に基づいて、ストレージ ・ オブジェクトの実装を持ちます。 特に、 **QueryInterface**メソッドが正常に機能しません。 COM の実装を使用して独自のストレージ オブジェクトを実装するサービス プロバイダーを作成します**IEnumSTATSTG**オブジェクトの基になる**IEnumSTATSTG**メソッドに呼び出しを転送するが、実装のシン ラッパー独自**AddRef**、**リリース**、**バージョン管理規則によって**、および**クローン**の方法です。 
  

