---
title: MAPI のStorage構造
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: '最終更新日: 2015 年 3 月 9 日'
ms.openlocfilehash: f58fa70e98841db5507323a63737f1df6c1b7a6d
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/28/2019
ms.locfileid: "33411751"
---
# <a name="structured-storage-in-mapi"></a><span data-ttu-id="a2476-103">MAPI のStorage構造</span><span class="sxs-lookup"><span data-stu-id="a2476-103">Structured Storage in MAPI</span></span>

  
  
<span data-ttu-id="a2476-104">**適用対象**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="a2476-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="a2476-105">構造化ストレージとは、COM で導入されたストレージの階層的な組織を指します。</span><span class="sxs-lookup"><span data-stu-id="a2476-105">Structured storage refers to the hierarchical organization of storage introduced with COM.</span></span> <span data-ttu-id="a2476-106">構造化ストレージ環境では、記憶域は次の 2 種類または 3 種類のオブジェクトに編成されます。</span><span class="sxs-lookup"><span data-stu-id="a2476-106">In a structured storage environment, storage is organized into two or three types of objects:</span></span> 
  
- <span data-ttu-id="a2476-107">Stream オブジェクト</span><span class="sxs-lookup"><span data-stu-id="a2476-107">Stream objects</span></span>
    
- <span data-ttu-id="a2476-108">バイト オブジェクトのロック</span><span class="sxs-lookup"><span data-stu-id="a2476-108">Lock bytes objects</span></span>
    
- <span data-ttu-id="a2476-109">Storageオブジェクト</span><span class="sxs-lookup"><span data-stu-id="a2476-109">Storage objects</span></span>
    
<span data-ttu-id="a2476-110">ストリームバイトとロック バイトは、データに直接アクセスする下位レベルのオブジェクトです。</span><span class="sxs-lookup"><span data-stu-id="a2476-110">Stream and lock bytes are lower-level objects that directly access the data.</span></span> <span data-ttu-id="a2476-111">Stream オブジェクトは **、データのバイトを** 読み取り、書き込み、配置、およびコピーするためのメソッドを定義する IStream インターフェイスを実装します。</span><span class="sxs-lookup"><span data-stu-id="a2476-111">Stream objects implement the **IStream** interface which defines methods for reading, writing, positioning, and copying bytes of data.</span></span> <span data-ttu-id="a2476-112">Lock bytes オブジェクトは、バイト配列を使用してデータにアクセスするための別の COM インターフェイス **ILockBytes** を実装します。</span><span class="sxs-lookup"><span data-stu-id="a2476-112">Lock bytes objects implement another COM interface, **ILockBytes**, to access data with a byte array.</span></span> <span data-ttu-id="a2476-113">バイト配列は、通常、基になる記憶域へのカスタマイズされたアクセスを提供するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="a2476-113">Byte arrays are typically used to provide customized access to underlying storage.</span></span>
  
<span data-ttu-id="a2476-114">Storageオブジェクトは、ストリーム オブジェクトまたはロック バイト オブジェクトの上に重なって表示されます。これらのオブジェクトには、1 つ以上のオブジェクトと他のストレージ オブジェクトを含めできます。</span><span class="sxs-lookup"><span data-stu-id="a2476-114">Storage objects are layered on top of the stream or lock bytes objects; they can contain one or more of these objects as well as other storage objects.</span></span> <span data-ttu-id="a2476-115">Storageは、入れ子になったオブジェクトを作成、アクセス、および管理するためのメソッドを定義する **IStorage** インターフェイスを実装します。</span><span class="sxs-lookup"><span data-stu-id="a2476-115">Storage objects implement the **IStorage** interface which defines methods for creating, accessing, and maintaining nested objects.</span></span> 
  
<span data-ttu-id="a2476-116">**IStream、ILockBytes、** および **IStorage** は MAPI インターフェイスではなく COM インターフェイスなので、メソッドは MAPI 値ではなく COM エラー値を返します。 </span><span class="sxs-lookup"><span data-stu-id="a2476-116">Because **IStream**, **ILockBytes**, and **IStorage** are COM interfaces rather than MAPI interfaces, their methods return COM error values rather than MAPI values.</span></span> <span data-ttu-id="a2476-117">これらのインターフェイスでメソッドを呼び出すクライアントとサービス プロバイダーは、API 関数 **MapStorageSCode** を使用して、これらの値を MAPI エラー値に変換する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a2476-117">Clients and service providers calling methods in these interfaces must use the API function **MapStorageSCode** to translate these values into MAPI error values.</span></span> <span data-ttu-id="a2476-118">詳細については [、「MapStorageSCode」を参照してください](mapstoragescode.md)。</span><span class="sxs-lookup"><span data-stu-id="a2476-118">For more information, see [MapStorageSCode](mapstoragescode.md).</span></span>
  
<span data-ttu-id="a2476-119">クライアントとサービス プロバイダーは **、IMAPIProp** メソッド (通常は大きな文字列プロパティとバイナリ プロパティ) を維持するには大きすぎるプロパティを操作するために構造化ストレージを使用します。</span><span class="sxs-lookup"><span data-stu-id="a2476-119">Clients and service providers use structured storage for working with properties that are too large to maintain with the **IMAPIProp** methods, typically large string and binary properties.</span></span> <span data-ttu-id="a2476-120">クライアントまたはサービス プロバイダーがアクセスする一般的な方法の 1 つは [、IMAPIProp::OpenProperty](imapiprop-openproperty.md)メソッドの呼び出しでインターフェイス識別子として **IStream** または **IStorage** を指定する方法です。</span><span class="sxs-lookup"><span data-stu-id="a2476-120">One of the common ways that clients or service providers access them is by specifying **IStream** or **IStorage** as the interface identifier in a call to the [IMAPIProp::OpenProperty](imapiprop-openproperty.md) method.</span></span> <span data-ttu-id="a2476-121">たとえば、クライアントは **OpenProperty** **を** プロパティ PR_ATTACH_DATA_BIN として呼び出し、IID_IStream をインターフェイス識別子として呼び出して、メッセージ内のバイナリ添付ファイルにアクセスします。</span><span class="sxs-lookup"><span data-stu-id="a2476-121">For example, clients call **OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag and IID_IStream as the interface identifier to access a binary attachment in a message.</span></span> 
  
<span data-ttu-id="a2476-122">クライアントとサービス プロバイダーは、独自のストリーム オブジェクトと記憶域オブジェクトを実装したり、API 関数を呼び出して、MAPI または COM によって提供される実装にアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="a2476-122">Clients and service providers can implement their own stream and storage objects or call API functions to access implementations supplied by MAPI or COM.</span></span> <span data-ttu-id="a2476-123">提供される実装はほとんどの目的に役立つため、クライアントとサービス プロバイダーが独自の実装を作成する必要はほとんどありません。</span><span class="sxs-lookup"><span data-stu-id="a2476-123">Because the supplied implementations serve most purposes, clients and service providers rarely need to create their own.</span></span> 
  
<span data-ttu-id="a2476-124">クライアントが MAPI オブジェクト **の OpenProperty** を呼び出して、ストレージ オブジェクトを介してプロパティの 1 つにアクセスすると、サービス プロバイダーは通常、直接モードでストレージ オブジェクトを開きます。</span><span class="sxs-lookup"><span data-stu-id="a2476-124">When a client calls **OpenProperty** on a MAPI object to access one of its properties through a storage object, the service provider will typically open the storage object in direct mode.</span></span> <span data-ttu-id="a2476-125">ただし、これは必須の動作ではなく一般的です。</span><span class="sxs-lookup"><span data-stu-id="a2476-125">However, this is typical rather than required behavior.</span></span> <span data-ttu-id="a2476-126">クライアントは、サービス プロバイダーによって開かまたは作成されたストレージ オブジェクトはすべてトランザクション化され **、IStorage::Commit** への呼び出しが必要と想定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a2476-126">Clients should assume that all storage objects opened or created by service providers are transacted and require a call to **IStorage::Commit**.</span></span> <span data-ttu-id="a2476-127">また、MAPI オブジェクトを保存する最後の Commit の後に **IMAPIProp::SaveChanges** を呼び出すまで、ストレージ オブジェクトへの変更は永続的に行ななわれたりしません。</span><span class="sxs-lookup"><span data-stu-id="a2476-127">They should also remember that changes to storage objects will not be made permanent until they call **IMAPIProp::SaveChanges** after the final **Commit** to save the MAPI object.</span></span> <span data-ttu-id="a2476-128">詳細については [、「IMAPIProp::SaveChanges」を参照してください](imapiprop-savechanges.md)。</span><span class="sxs-lookup"><span data-stu-id="a2476-128">For more information, see [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span></span>
  
<span data-ttu-id="a2476-129">MAPI と COM には、ストレージ オブジェクトとストリーム オブジェクトを定義またはアクセスするためのいくつかの API 関数が備わっています。</span><span class="sxs-lookup"><span data-stu-id="a2476-129">MAPI and COM provide several API functions for defining or accessing storage and stream objects.</span></span> <span data-ttu-id="a2476-130">一般的に使用される関数については、次の表で説明します。</span><span class="sxs-lookup"><span data-stu-id="a2476-130">The commonly used functions are described in the following table.</span></span>
  
<span data-ttu-id="a2476-131">**ストリーム オブジェクトとストリーム オブジェクトStorageアクセスする関数**</span><span class="sxs-lookup"><span data-stu-id="a2476-131">**Functions for Accessing Storage and Stream Objects**</span></span>

|<span data-ttu-id="a2476-132">**Function**</span><span class="sxs-lookup"><span data-stu-id="a2476-132">**Function**</span></span>|<span data-ttu-id="a2476-133">**説明**</span><span class="sxs-lookup"><span data-stu-id="a2476-133">**Description**</span></span>|
|:-----|:-----|
|[<span data-ttu-id="a2476-134">HrIStorageFromStream</span><span class="sxs-lookup"><span data-stu-id="a2476-134">HrIStorageFromStream</span></span>](hristoragefromstream.md) <br/> |<span data-ttu-id="a2476-135">ストリームまたはロック バイト オブジェクトにアクセスするストレージ オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="a2476-135">Creates a storage object to access a stream or lock bytes object.</span></span>  <br/> |
|[<span data-ttu-id="a2476-136">OpenIMsgOnIStg</span><span class="sxs-lookup"><span data-stu-id="a2476-136">OpenIMsgOnIStg</span></span>](openimsgonistg.md) <br/> |<span data-ttu-id="a2476-137">ストレージ オブジェクトにアクセスするメッセージ オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="a2476-137">Creates a message object to access a storage object.</span></span>  <br/> |
|[<span data-ttu-id="a2476-138">OpenStreamOnFile</span><span class="sxs-lookup"><span data-stu-id="a2476-138">OpenStreamOnFile</span></span>](openstreamonfile.md) <br/> |<span data-ttu-id="a2476-139">ファイルにアクセスするストリーム オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="a2476-139">Creates a stream object to access a file.</span></span>  <br/> |
|[<span data-ttu-id="a2476-140">WrapCompressedRTFStream</span><span class="sxs-lookup"><span data-stu-id="a2476-140">WrapCompressedRTFStream</span></span>](wrapcompressedrtfstream.md) <br/> |<span data-ttu-id="a2476-141">メッセージのリッチ テキストを保持するストリームの圧縮バージョンまたは非圧縮バージョンを含むストリーム オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="a2476-141">Creates a stream object that contains the compressed or uncompressed version of a stream holding the rich text of a message.</span></span>  <br/> |
   
 <span data-ttu-id="a2476-142">**特定のサブストルジ内のストリームの名前を取得するには**</span><span class="sxs-lookup"><span data-stu-id="a2476-142">**To retrieve the names of the streams in a given substorage**</span></span>
  
1. <span data-ttu-id="a2476-143">**IEnumSTATSTG** インターフェイスを取得するには **、substorage の IStorage::EnumElements** メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="a2476-143">Call the substorage's **IStorage::EnumElements** method to get an **IEnumSTATSTG** interface.</span></span> 
    
2. <span data-ttu-id="a2476-144">**IEnumSTATSTG::Next** を呼び出し、できる限り多くの **STATSTG** 構造を一度に呼び出します。</span><span class="sxs-lookup"><span data-stu-id="a2476-144">Call **IEnumSTATSTG::Next** with as many **STATSTG** structures at a time as you can.</span></span> <span data-ttu-id="a2476-145">一度に 100 を求める場合は、通常 _、pceltFetched_ の内容が実際に取得された番号に設定された S_FALSE が返されます。</span><span class="sxs-lookup"><span data-stu-id="a2476-145">If you ask for 100 at a time, **Next** will usually return S_FALSE with the contents of  _pceltFetched_ set to the number that were actually retrieved.</span></span> 
    
3. <span data-ttu-id="a2476-146">アプリケーションでフラグ **が設定されている STATSTG** 構造STGTY_STREAM。</span><span class="sxs-lookup"><span data-stu-id="a2476-146">Check for the **STATSTG** structures that are flagged with STGTY_STREAM.</span></span> 
    
4. <span data-ttu-id="a2476-147">_pwcsName パラメーターを解放_ します。</span><span class="sxs-lookup"><span data-stu-id="a2476-147">Release the  _pwcsName_ parameter.</span></span> 
    
 <span data-ttu-id="a2476-148">**既存のストリームまたはロック バイト オブジェクトにアクセスするストレージ オブジェクトを作成するには**</span><span class="sxs-lookup"><span data-stu-id="a2476-148">**To create a storage object to access an existing stream or lock bytes object**</span></span>
  
- <span data-ttu-id="a2476-149">クライアントは [HrIStorageFromStream を呼び出します](hristoragefromstream.md)。</span><span class="sxs-lookup"><span data-stu-id="a2476-149">Clients call [HrIStorageFromStream](hristoragefromstream.md).</span></span> 
    
 <span data-ttu-id="a2476-150">**既存のストレージ オブジェクトにアクセスするメッセージ オブジェクトを作成するには**</span><span class="sxs-lookup"><span data-stu-id="a2476-150">**To create a message object to access an existing storage object**</span></span>
  
- <span data-ttu-id="a2476-151">サービス プロバイダーとクライアントは [OpenIMsgOnIStg を呼び出します](openimsgonistg.md)。</span><span class="sxs-lookup"><span data-stu-id="a2476-151">Service providers and clients call [OpenIMsgOnIStg](openimsgonistg.md).</span></span> <span data-ttu-id="a2476-152">作成されるメッセージ オブジェクトは **、IMessage::SubmitMessage** など、[すべての IMessage : IMAPIProp](imessageimapiprop.md)インターフェイス メソッドをサポートしていないという点で、メッセージ ストア プロバイダーによって通常作成されるメッセージ オブジェクトとは異なります。</span><span class="sxs-lookup"><span data-stu-id="a2476-152">The message object that is created differs from the message objects typically created by message store providers in that it does not support all of the [IMessage : IMAPIProp](imessageimapiprop.md) interface methods, such as **IMessage::SubmitMessage**.</span></span> <span data-ttu-id="a2476-153">**OpenIMsgOnIStg** へのオプションの入力パラメーターは [、MSGCALLRELEASE](msgcallrelease.md)プロトタイプに準拠するコールバック関数です。</span><span class="sxs-lookup"><span data-stu-id="a2476-153">An optional input parameter to **OpenIMsgOnIStg** is a callback function that conforms to the [MSGCALLRELEASE](msgcallrelease.md) prototype.</span></span> <span data-ttu-id="a2476-154">この関数は、メッセージの参照カウントが 0 に達したときに、新しいメッセージ オブジェクトによって呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="a2476-154">This function is called by the new message object when the message's reference count reaches zero.</span></span> <span data-ttu-id="a2476-155">**MSGCALLRELEASE** 関数を実装すると、新しいメッセージが完全に削除される前に、最終的な処理を実行する場合に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="a2476-155">Implementing a **MSGCALLRELEASE** function can be useful for performing final processing before the new message is completely removed.</span></span> 
    
<span data-ttu-id="a2476-156">[OpenStreamOnFile](openstreamonfile.md) は、ファイルの読み取りと書き込みを行うストリームを作成するファイル添付ファイルの格納に一般的に使用されます。</span><span class="sxs-lookup"><span data-stu-id="a2476-156">[OpenStreamOnFile](openstreamonfile.md) is commonly used for storing file attachments because it creates a stream that reads from and writes to a file.</span></span> <span data-ttu-id="a2476-157">**OpenProperty** プロパティ **PR_ATTACH_DATA_BIN** として指定すると、バイナリ添付ファイル データを格納するためのストリームが作成されます。</span><span class="sxs-lookup"><span data-stu-id="a2476-157">**OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag creates a stream for storing binary attachment data.</span></span> 
  
 <span data-ttu-id="a2476-158">**リッチ テキスト形式でメッセージ テキストを含むストリームを圧縮または圧縮解除するには**</span><span class="sxs-lookup"><span data-stu-id="a2476-158">**To compress or uncompress a stream containing message text in the Rich Text Format**</span></span>
  
- <span data-ttu-id="a2476-159">クライアントは [WrapCompressedRTFStream を呼び出します](wrapcompressedrtfstream.md)。</span><span class="sxs-lookup"><span data-stu-id="a2476-159">Clients call [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span></span> <span data-ttu-id="a2476-160">**WrapCompressedRTFStream は** 、RTF ストリームをラップするストリームを作成します。</span><span class="sxs-lookup"><span data-stu-id="a2476-160">**WrapCompressedRTFStream** creates a stream that wraps the RTF stream.</span></span> <span data-ttu-id="a2476-161">ラッパー ストリームは、すべての **IStream メソッドを実装する** 必要があります。次のメソッドは除外されます **。Seek**、SetSize、Revert、LockRegion、UnlockRegion、Stat、および **Clone** です。    </span><span class="sxs-lookup"><span data-stu-id="a2476-161">The wrapper stream does not implement all of the **IStream** methods; the following methods are excluded: **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat**, and **Clone**.</span></span> <span data-ttu-id="a2476-162">**これは、WrapCompressedRTFStream** によって作成されたストリーム オブジェクトが **SetSize** または **Stat** をサポートしていないためです。サイズを拡張または取得する簡単な方法はありません。</span><span class="sxs-lookup"><span data-stu-id="a2476-162">This is because the stream objects created by **WrapCompressedRTFStream** do not support either **SetSize** or **Stat**, there is not an easy way to either extend or retrieve their size.</span></span> <span data-ttu-id="a2476-163">最適な方法は、妥当なバッファー サイズを選択し、ループ内で読み取りまたは書き込みを行う方法です。</span><span class="sxs-lookup"><span data-stu-id="a2476-163">The best strategy is to pick a reasonable buffer size and read or write in a loop.</span></span>
    
> [!NOTE]
> <span data-ttu-id="a2476-164">COM には、問題のある **EnumElements** メソッドから **IEnumSTATSTG** オブジェクトを返すバイト配列に基づくストレージ オブジェクトの実装があります。</span><span class="sxs-lookup"><span data-stu-id="a2476-164">COM has a storage object implementation based on a byte array that returns an **IEnumSTATSTG** object from the **EnumElements** method that is problematic.</span></span> <span data-ttu-id="a2476-165">特に **、QueryInterface** メソッドが正しく動作しません。</span><span class="sxs-lookup"><span data-stu-id="a2476-165">In particular, the **QueryInterface** method does not work correctly.</span></span> <span data-ttu-id="a2476-166">COM 実装を使用して独自のストレージ オブジェクトを実装するサービス プロバイダーは、基になる IEnumSTATSTG メソッドへの呼び出しを転送するが、独自の **AddRef** メソッド、Release メソッド **、QueryInterface** メソッド、**および Clone** メソッドを実装する **IEnumSTATSTG** オブジェクトのシン ラッパーを作成する必要があります。 </span><span class="sxs-lookup"><span data-stu-id="a2476-166">Service providers that implement their own storage objects using the COM implementation should create a thin wrapper for the **IEnumSTATSTG** object that forwards calls on to the underlying **IEnumSTATSTG** methods but implements its own **AddRef**, **Release**, **QueryInterface**, and **Clone** methods.</span></span> 
  

