---
title: イベント通知のサポート
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: a1e3e49c-8d1d-4f7e-ba5a-be441f0f10ae
description: '最終更新日: 2011 年 7 月 23 日'
ms.openlocfilehash: 83c102c25b17b6769c0c676bbadd874224f75cf6
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/23/2019
ms.locfileid: "32327427"
---
# <a name="supporting-event-notification"></a><span data-ttu-id="ad4bc-103">イベント通知のサポート</span><span class="sxs-lookup"><span data-stu-id="ad4bc-103">Supporting Event Notification</span></span>

  
  
<span data-ttu-id="ad4bc-104">**適用対象**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="ad4bc-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="ad4bc-105">サポートイベント通知は複雑になる可能性があるため、MAPI には、プロセスの最も困難な部分を実装する3つのサポートオブジェクトメソッドが用意されています。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-105">Because supporting event notification can be complicated, MAPI supplies three support object methods that implement the most difficult parts of the process.</span></span> <span data-ttu-id="ad4bc-106">これらのメソッドは1つの単位として機能し、プロバイダーはこれらすべてを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-106">These methods work as a unit, and a provider must use all three or none of them.</span></span>
  
<span data-ttu-id="ad4bc-107">MAPI サポートメソッドは通知キーを使用して、アドバイズシンクと通知を生成するオブジェクトとの間の接続を管理します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-107">The MAPI support methods use notification keys to manage the connections between the advise sinks and the objects that generate the notifications.</span></span> <span data-ttu-id="ad4bc-108">通知キーは、プロセス間でオブジェクトを識別するバイナリデータを含む[NOTIFKEY](notifkey.md)構造です。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-108">A notification key is a [NOTIFKEY](notifkey.md) structure that contains binary data that identifies an object across processes.</span></span> <span data-ttu-id="ad4bc-109">通知キーは、通常、アドバイズソースオブジェクトの長期のエントリ識別子からコピーされます。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-109">A notification key is typically copied from the long-term entry identifier of the advise source object.</span></span> <span data-ttu-id="ad4bc-110">通知を受け取る呼び出しでクライアントがエントリ識別子を指定し\*\*\*\* ている場合は、それを通知キーに使用できます。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-110">If the client has supplied an entry identifier in the call to **Advise**, you can use it for the notification key.</span></span> <span data-ttu-id="ad4bc-111">**アドバイズ**の_lな tryid_パラメーターが NULL の場合は、メッセージストアなど、最も外側に考えられるコンテナーオブジェクトのエントリ識別子を使用します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-111">If the  _lpEntryID_ parameter to **Advise** is NULL, use the entry identifier of the outermost possible container object, such as the message store.</span></span> 
  
<span data-ttu-id="ad4bc-112">サポート方法を使用するには、クライアントが通知を登録するために**アドバイズ**メソッドを呼び出すときに、 [imapisupport:: Subscribe](imapisupport-subscribe.md)を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-112">To use the support methods, call [IMAPISupport::Subscribe](imapisupport-subscribe.md) whenever a client calls your **Advise** method to register for a notification.</span></span> <span data-ttu-id="ad4bc-113">[NOTIFKEY](notifkey.md)構造体を割り当て、アドバイズソースオブジェクト用の一意の通知キーを作成します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-113">Allocate a [NOTIFKEY](notifkey.md) structure and create a unique notification key for your advise source object.</span></span> <span data-ttu-id="ad4bc-114">たとえば、メッセージを特定のフォルダーに受信したときにクライアントに通知するように求めるメッセージストアプロバイダーは、そのフォルダーの通知キーを作成します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-114">For example, a message store provider that is prompted to notify a client when a message is received into a particular folder creates a notification key for that folder.</span></span> <span data-ttu-id="ad4bc-115">呼び出しの**NOTIFKEY**構造体へのポインターを渡して、クライアントのアドバイズシンクへのポインターと共に**サブスクライブ**します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-115">Pass a pointer to the **NOTIFKEY** structure in the call to **Subscribe** along with a pointer to the client's advise sink.</span></span> <span data-ttu-id="ad4bc-116">**Subscribe**は、アドバイズシンクの[IUnknown:: AddRef](https://msdn.microsoft.com/library/b4316efd-73d4-4995-b898-8025a316ba63%28Office.15%29.aspx)メソッドを呼び出して参照カウントをインクリメントし、MAPI は登録が取り消されるまでポインターを保持します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-116">**Subscribe** calls the advise sink's [IUnknown::AddRef](https://msdn.microsoft.com/library/b4316efd-73d4-4995-b898-8025a316ba63%28Office.15%29.aspx) method to increment its reference count and MAPI retains the pointer until the registration is canceled.</span></span> 
  
<span data-ttu-id="ad4bc-117">NOTIFY_SYNC フラグを渡すと、**通知**が同期され、登録されているアドバイズシンクの[IMAPIAdviseSink:: onnotify](imapiadvisesink-onnotify.md)メソッドへのすべての呼び出しが行われるまで返されない要求を**サブスクライブ**できます。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-117">You can pass the NOTIFY_SYNC flag to **Subscribe** to request that **Notify** behave synchronously and not return until it has made all calls to the [IMAPIAdviseSink::OnNotify](imapiadvisesink-onnotify.md) methods of registered advise sinks.</span></span> <span data-ttu-id="ad4bc-118">このフラグは、自分の内部使用目的にのみ設定します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-118">Set this flag only for your own internal use.</span></span> <span data-ttu-id="ad4bc-119">クライアント**アドバイズ**呼び出しに応答するときには、この設定を行わないでください。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-119">Do not set it when you respond to a client **Advise** call.</span></span> <span data-ttu-id="ad4bc-120">クライアントとプロバイダーの間のイベント通知は常に非同期です。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-120">Event notification between clients and providers is always asynchronous.</span></span> <span data-ttu-id="ad4bc-121">つまり、MAPI では、イベントが発生する呼び出しは、 **onnotify**呼び出しが行われる前にクライアントに返されることが保証されます。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-121">That is, MAPI guarantees that the call during which an event happens will return to the client before any of the **OnNotify** calls are made.</span></span> 
  
<span data-ttu-id="ad4bc-122">NOTIFY_SYNC フラグを設定した場合は、アドバイズシンクオブジェクトに一切変更を加えず、 [HrThisThreadAdviseSink](hrthisthreadadvisesink.md)によって作成されたラッパーアドバイズシンクを**サブスクライブ**に渡しません。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-122">If you set the NOTIFY_SYNC flag, do not make any changes to any of the advise sink objects, and do not pass a wrapper advise sink created by [HrThisThreadAdviseSink](hrthisthreadadvisesink.md) to **Subscribe**.</span></span> <span data-ttu-id="ad4bc-123">**HrThisThreadAdviseSink**は、非同期通知にのみ使用される、アドバイズシンクのスレッドセーフバージョンを作成します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-123">**HrThisThreadAdviseSink** creates a thread-safe version of an advise sink to be used with asynchronous notification only.</span></span> 
  
<span data-ttu-id="ad4bc-124">同期通知用に登録されたアドバイズシンクが CALLBACK_DISCONTINUE フラグセットを使用して**onnotify**から戻る場合、 [imapisupport:: notify](imapisupport-notify.md)は NOTIFY_CANCELED フラグを設定し、 **onnotify**を呼び出すことなく戻ります。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-124">If an advise sink registered for synchronous notification returns from **OnNotify** with the CALLBACK_DISCONTINUE flag set, [IMAPISupport::Notify](imapisupport-notify.md) sets the NOTIFY_CANCELED flag and returns without making any calls to **OnNotify**.</span></span> 
  
<span data-ttu-id="ad4bc-125">**Subscribe**が戻った後、クライアントのアドバイズシンクのコピーを保持する必要がなくなります。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-125">Once **Subscribe** has returned, you will no longer have any need to hold onto your copy of the client's advise sink.</span></span> <span data-ttu-id="ad4bc-126">[IUnknown:: release](https://msdn.microsoft.com/library/4b494c6f-f0ee-4c35-ae45-ed956f40dc7a%28Office.15%29.aspx)メソッドを呼び出して解放します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-126">Call its [IUnknown::Release](https://msdn.microsoft.com/library/4b494c6f-f0ee-4c35-ae45-ed956f40dc7a%28Office.15%29.aspx) method to release it.</span></span> <span data-ttu-id="ad4bc-127">**Subscribe**は、クライアントに返す必要がある0以外の接続番号を返します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-127">**Subscribe** returns a nonzero connection number that you should return to the client.</span></span> <span data-ttu-id="ad4bc-128">接続番号は、アドバイズソースとアドバイズシンクの間のリンクを表します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-128">The connection number represents the link between the advise source and the advise sink.</span></span> <span data-ttu-id="ad4bc-129">クライアントが**アドバイズ**中止の呼び出しを正常に行うまで、これは有効なままとなります。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-129">It remains valid until the client makes a successful call to **Unadvise**.</span></span> 
  
<span data-ttu-id="ad4bc-130">クライアントが登録を取り消す準備ができたら、**アドバイズ**中止メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-130">When the client is ready to cancel a registration, it calls your **Unadvise** method.</span></span> <span data-ttu-id="ad4bc-131">**アドバイズ**中止呼び出しから[imapisupport::](imapisupport-unsubscribe.md)登録を解除する接続番号を渡します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-131">Pass the connection number from the **Unadvise** call to [IMAPISupport::Unsubscribe](imapisupport-unsubscribe.md).</span></span> <span data-ttu-id="ad4bc-132">登録**解除**アドバイズシンクの**IUnknown:: Release**メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-132">**Unsubscribe** calls the advise sink's **IUnknown::Release** method.</span></span> <span data-ttu-id="ad4bc-133">**アドバイズ**および**アドバイズ**の場合と同様に、 **Subscribe**および**講読**の呼び出しをペアにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-133">As with **Advise** and **Unadvise**, calls to **Subscribe** and **Unsubscribe** must be paired.</span></span> <span data-ttu-id="ad4bc-134">**Subscribe**に対して行われ\*\*\*\* たすべての呼び出しに対して1回の呼び出しをサブスクライブする必要があります。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-134">You must make one call to **Unsubscribe** for every call that is made to **Subscribe**.</span></span> <span data-ttu-id="ad4bc-135">ただし、**アドバイズ**メソッドが呼び出されるたびに**Subscribe**を呼び出す必要はありません。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-135">However, you do not have to call **Subscribe** every time your **Advise** method is called.</span></span> <span data-ttu-id="ad4bc-136">逆に、内部通知を設定するために呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-136">Conversely, you can call it for setting up internal notifications.</span></span> 
  
<span data-ttu-id="ad4bc-137">イベントが発生したときに、そのイベントに適した型の1つまたは複数の[通知](notification.md)構造を割り当て、: [: Notify](imapisupport-notify.md)を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-137">When an event occurs, allocate one or more [NOTIFICATION](notification.md) structures of the type appropriate for the event and call [IMAPISupport::Notify](imapisupport-notify.md).</span></span> <span data-ttu-id="ad4bc-138">**Notify**登録されたアドバイズシンクごとに通知を生成します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-138">**Notify** generates a notification for each registered advise sink.</span></span> <span data-ttu-id="ad4bc-139">[通知](notification.md)構造の使用されていないすべてのメンバーを0に設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-139">You should set all the unused members of the [NOTIFICATION](notification.md) structure to zero.</span></span> <span data-ttu-id="ad4bc-140">**通知**構造を初期化する手法を使用すると、クライアントは、より小さく、短時間、エラーが発生しやすい**onnotify**実装を作成できます。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-140">This technique for initializing the **NOTIFICATION** structure can help clients create smaller, faster, and less error-prone **OnNotify** implementations.</span></span> 
  
<span data-ttu-id="ad4bc-141">同じ種類の複数のイベントであっても、各イベントに対して別々の**通知**構造が必要になることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-141">Note that a separate **NOTIFICATION** structure is necessary for each event, even for multiple events of the same type.</span></span> <span data-ttu-id="ad4bc-142">たとえば、特定のテーブルに対してテーブル通知のために3つのクライアントが登録されており、そのテーブルに5つの行が追加されている場合は、**通知**呼び出し用に5つの**OBJECT_NOTIFICATION**構造を作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-142">For example, if three clients are registered for table notification on a particular table and five rows are added to the table, you must create five **OBJECT_NOTIFICATION** structures for your **Notify** call.</span></span> <span data-ttu-id="ad4bc-143">このようなバッチ通知は、**通知**を5回呼び出した場合よりもパフォーマンスが向上します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-143">A batch notification such as this results in better performance than calling **Notify** five times.</span></span> <span data-ttu-id="ad4bc-144">**通知**呼び出しごとに、MAPI は登録されたすべてのアドバイズシンクの[IMAPIAdviseSink:: onnotify](imapiadvisesink-onnotify.md)メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-144">For each **Notify** call, MAPI calls the [IMAPIAdviseSink::OnNotify](imapiadvisesink-onnotify.md) method of every registered advise sink.</span></span> <span data-ttu-id="ad4bc-145">登録されたアドバイズシンクが存在しない場合、MAPI は呼び出しを無視します。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-145">If there are no registered advise sinks, MAPI ignores the call.</span></span> 
  
<span data-ttu-id="ad4bc-146">バッチ処理された通知を送信するサービスプロバイダーは、最初の通知から最後の通知への変換が可能になるように順序付けする必要があります。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-146">Service providers that send batched notifications must order them so that they can be interpreted from the first notification to the last.</span></span> <span data-ttu-id="ad4bc-147">この順序付けが必要になるのは、同じバッチ内で別のイベントに追加された前の行を参照する1つのイベントを含む TABLE_ROW_ADDED などの一連のイベントが通知バッチに含まれている場合です。</span><span class="sxs-lookup"><span data-stu-id="ad4bc-147">This ordering is especially necessary when a notification batch contains a series of events, such as TABLE_ROW_ADDED with one event that refers to a prior row that was added in another event in the same batch.</span></span>
  
## <a name="see-also"></a><span data-ttu-id="ad4bc-148">関連項目</span><span class="sxs-lookup"><span data-stu-id="ad4bc-148">See also</span></span>



[<span data-ttu-id="ad4bc-149">MAPI サービスプロバイダー</span><span class="sxs-lookup"><span data-stu-id="ad4bc-149">MAPI Service Providers</span></span>](mapi-service-providers.md)

