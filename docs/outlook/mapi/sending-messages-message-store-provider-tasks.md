---
title: メッセージのメッセージ ストア プロバイダーのタスクを送信します。
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: acbfd3ae-bfdc-4103-bed2-6bcf7b9c448c
description: '最終更新日時: 2015 年 3 月 9 日'
ms.openlocfilehash: 8bfa5709dede4a9501d261e0f495acbc0894b470
ms.sourcegitcommit: 9d60cd82b5413446e5bc8ace2cd689f683fb41a7
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/11/2018
ms.locfileid: "19803873"
---
# <a name="sending-messages-message-store-provider-tasks"></a><span data-ttu-id="e1e9a-103">メッセージの送信: メッセージ ストア プロバイダーのタスク</span><span class="sxs-lookup"><span data-stu-id="e1e9a-103">Sending Messages: Message Store Provider Tasks</span></span>

<span data-ttu-id="e1e9a-104">**適用対象**: Outlook</span><span class="sxs-lookup"><span data-stu-id="e1e9a-104">**Applies to**: Outlook</span></span> 
  
<span data-ttu-id="e1e9a-105">メッセージ ストア プロバイダーは、クライアントがメッセージの[IMessage::SubmitMessage](imessage-submitmessage.md)メソッドを呼び出すと、プロセスを送信するメッセージに関連する取得します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-105">A message store provider gets involved with the message sending process when a client calls the message's [IMessage::SubmitMessage](imessage-submitmessage.md) method.</span></span> <span data-ttu-id="e1e9a-106">複数のメッセージを送信する場合は、メッセージ ・ ストアの**SubmitMessage**呼び出しのクライアントが使用されることと同じ順序でを送信する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-106">If multiple messages are to be sent, the message store must send them in the same order that the client used for its **SubmitMessage** calls.</span></span> 
  
<span data-ttu-id="e1e9a-107">メッセージ ストア プロバイダーでは、MAPI スプーラーが参加するかどうかを指定します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-107">The message store provider determines whether or not to involve the MAPI spooler.</span></span> <span data-ttu-id="e1e9a-108">メッセージ ストア プロバイダーが密に結合されていない場合、メッセージは、プリプロセスを必要とまたは密結合のストアとトランスポートを処理できないすべての受信者、MAPI スプーラーが関与している必要があります。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-108">If the message store provider is not tightly coupled, the message requires preprocessing, or the tightly coupled store and transport cannot handle all of the recipients, the MAPI spooler must be involved.</span></span> 
  
<span data-ttu-id="e1e9a-109">次の手順では、メッセージ ストア プロバイダーのメッセージを送信するために必要なタスクについて説明します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-109">The following procedure describes the tasks required of a message store provider for sending a message.</span></span> 
  
<span data-ttu-id="e1e9a-110">**IMessage::SubmitMessage では、メッセージは、プロバイダーを格納**します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-110">**In IMessage::SubmitMessage, the message store provider**:</span></span>
  
1. <span data-ttu-id="e1e9a-111">メッセージ、MSGFLAG_RESEND フラグを**PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) プロパティに設定があり、クライアントにエラーを返す場合は、 [IMAPISupport::PrepareSubmit](imapisupport-preparesubmit.md)を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-111">Calls [IMAPISupport::PrepareSubmit](imapisupport-preparesubmit.md) if the message has the MSGFLAG_RESEND flag set in its **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) property and returns any errors to the client.</span></span> <span data-ttu-id="e1e9a-112">**PrepareSubmit**は、メッセージの宛先リストの各受信者の**PR_RECIPIENT_TYPE** ([PidTagRecipientType](pidtagrecipienttype-canonical-property.md)) のプロパティをチェックします。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-112">**PrepareSubmit** checks the **PR_RECIPIENT_TYPE** ([PidTagRecipientType](pidtagrecipienttype-canonical-property.md)) property of each recipient in the message's recipient list.</span></span>
    
   - <span data-ttu-id="e1e9a-113">MAPI_SUBMITTED フラグが設定されている場合、受信者が元のメッセージを受信しなかったことを示す**PrepareSubmit**フラグをクリアし、**れない**([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) プロパティを TRUE に設定します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-113">If the MAPI_SUBMITTED flag is set, indicating that the recipient did not receive the original message, **PrepareSubmit** clears the flag and sets the **PR_RESPONSIBILITY** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) property to TRUE.</span></span> 
    
   - <span data-ttu-id="e1e9a-114">MAPI_SUBMITTED フラグが設定されていない場合、受信者に、元のメッセージを受け取ったことを示す**PrepareSubmit** 、 **PR_RECIPIENT_TYPE**プロパティを MAPI_P1 に変更**れない**プロパティを TRUE に設定してを返しますクライアントに**PrepareSubmit**によって生成されたエラーです。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-114">If the MAPI_SUBMITTED flag is not set, indicating that the recipient did receive the original messsage, **PrepareSubmit** changes the **PR_RECIPIENT_TYPE** property to MAPI_P1 and sets the **PR_RESPONSIBILITY** property to TRUE and returns any error generated by **PrepareSubmit** to the client.</span></span> 
    
2. <span data-ttu-id="e1e9a-115">メッセージの**PR_MESSAGE_FLAGS**プロパティに MSGFLAG_SUBMIT フラグを設定します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-115">Sets the MSGFLAG_SUBMIT flag in the message's **PR_MESSAGE_FLAGS** property.</span></span> 
    
3. <span data-ttu-id="e1e9a-116">**れない**受信者テーブルの列が存在し、まだと仮定しての責任、メッセージを送信するためのトランスポートが含まれていないことを示すために FALSE に設定します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-116">Makes sure that there is a column for **PR_RESPONSIBILITY** in the recipient table and sets it to FALSE to indicate that no transport has of yet assumed responsibility for transmitting the message.</span></span> 
    
4. <span data-ttu-id="e1e9a-117">**PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)) のプロパティの元の日時を設定します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-117">Sets the date and time of origination in the **PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)) property.</span></span>
    
5. <span data-ttu-id="e1e9a-118">[IMAPISupport::ExpandRecips](imapisupport-expandrecips.md)を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-118">Calls [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md) to:</span></span> 
    
   - <span data-ttu-id="e1e9a-119">すべての個人用配布リストとカスタム受信者を展開し、すべての変更された表示名を元の名前に置き換えます。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-119">Expand all personal distribution lists and custom recipients and replace all changed display names with their original names.</span></span>
   - <span data-ttu-id="e1e9a-120">重複した名前を削除します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-120">Remove duplicate names.</span></span>
   - <span data-ttu-id="e1e9a-121">必要な処理を確認し、前処理が必要な場合、NEEDS_PREPROCESSING フラグと**PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)) は、MAPI の予約済みのプロパティを設定します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-121">Check for any required preprocessing, and if preprocessing is required, set the NEEDS_PREPROCESSING flag and the **PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)) property, a property reserved for MAPI.</span></span> 
   - <span data-ttu-id="e1e9a-122">メッセージ ・ ストアは、トランスポートと密接に関連し、すべての受信者を処理できない場合は、NEEDS_SPOOLER フラグを設定します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-122">Set the NEEDS_SPOOLER flag if the message store is tightly coupled with a transport and it cannot handle all of the recipients.</span></span> 
    
6. <span data-ttu-id="e1e9a-123">NEEDS_PREPROCESSING メッセージのフラグが設定されている場合は、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-123">Performs the following tasks if the NEEDS_PREPROCESSING message flag is set:</span></span>
    
   - <span data-ttu-id="e1e9a-124">**PR_SUBMIT_FLAGS** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)) プロパティで設定された SUBMITFLAG_PREPROCESS ビットを使用して、送信キューにメッセージを配置します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-124">Puts the message in the outgoing queue with the SUBMITFLAG_PREPROCESS bit set in the **PR_SUBMIT_FLAGS** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)) property.</span></span>
   - <span data-ttu-id="e1e9a-125">MAPI スプーラー キューが変更されたことを通知します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-125">Notifies the MAPI spooler that the queue has changed.</span></span>
   - <span data-ttu-id="e1e9a-126">、クライアントに制御を返しますし、メッセージ フロー、MAPI スプーラーを無効にします。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-126">Returns control to the client, and message flow continues in the MAPI spooler.</span></span> 
   - <span data-ttu-id="e1e9a-127">MAPI スプーラーは、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-127">The MAPI spooler performs the following tasks:</span></span>
     - <span data-ttu-id="e1e9a-128">IMsgStore::SetLockState を呼び出すことによって、メッセージをロックします。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-128">Locks the message by calling IMsgStore::SetLockState.</span></span> 
     - <span data-ttu-id="e1e9a-129">すべての登録の順序でプリプロセッサ関数を呼び出すことによって必要な前処理を実行します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-129">Performs the needed preprocessing by calling all of the preprocessing functions in the order of registration.</span></span> <span data-ttu-id="e1e9a-130">トランスポート プロバイダーでは、前処理の関数を登録するのには IMAPISupport::RegisterPreprocessor を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-130">Transport providers call IMAPISupport::RegisterPreprocessor to register preprocessing functions.</span></span> 
     - <span data-ttu-id="e1e9a-131">メッセージ ・ ストアに事前処理が完了したことを示すメッセージを開いた状態で IMessage::SubmitMessage を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-131">Calls IMessage::SubmitMessage on the open message to indicate to the message store that preprocessing is complete.</span></span>

<br/>

<span data-ttu-id="e1e9a-132">かどうかがなく、前処理が処理された場合に、MAPI スプーラーが**SubmitMessage**を呼び出すと、次の 2 つの手順はクライアント プロセスで発生します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-132">The following two steps occur in the client process if there was no preprocessing, and when the MAPI spooler calls **SubmitMessage** if there was preprocessing.</span></span> 

<span data-ttu-id="e1e9a-133">**メッセージは、プロバイダーを格納**します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-133">**The message store provider**:</span></span>

1. <span data-ttu-id="e1e9a-134">メッセージ ・ ストアは、トランスポートに密に結合し、NEEDS_SPOOLER フラグは、 [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md)から返された場合は、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-134">Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):</span></span>
    
   - <span data-ttu-id="e1e9a-135">処理可能なすべての受信者を処理します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-135">Handles any recipients that it can handle.</span></span>
   - <span data-ttu-id="e1e9a-136">**れない**プロパティを設定しますが、処理するすべての受信者。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-136">Sets the **PR_RESPONSIBILITY** property to TRUE for any recipients that it handles.</span></span> 
   - <span data-ttu-id="e1e9a-137">このストアの密結合とトランスポートのすべての受信者がわかっている場合は、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-137">Performs the following tasks if all recipients are known to this tightly coupled store and transport:</span></span>
     - <span data-ttu-id="e1e9a-138">メッセージのプリプロセスまたは、メッセージ ・ ストア プロバイダーの要望をお勧めするため、メッセージのフックを呼び出すことができるメッセージの処理を完了するのには MAPI スプーラーは、IMAPISupport::CompleteMsg を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-138">Calls IMAPISupport::CompleteMsg if the message was preprocessed or the message store provider wants the MAPI spooler to complete message processing which is recommended so that messaging hooks can be invoked.</span></span> <span data-ttu-id="e1e9a-139">メッセージ フローは、次の手順に従って、MAPI スプーラーを続行します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-139">Message flow continues with the MAPI spooler as described in the following procedure.</span></span>  
     - <span data-ttu-id="e1e9a-140">メッセージのプリプロセスがしないか、メッセージ ストア プロバイダーは、メッセージの処理を完了するのには MAPI スプーラーを希望しない場合は、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-140">Performs the following tasks if the message was not preprocessed or the message store provider does not want the MAPI spooler to complete message processing:</span></span>
       - <span data-ttu-id="e1e9a-141">コピーの場合、PR_SENTMAIL_ENTRYID (PidTagSentMailEntryId) プロパティでは、エントリ id によって識別されたフォルダーにメッセージを設定します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-141">Copies the message to the folder identified by the entry identifier in the PR_SENTMAIL_ENTRYID (PidTagSentMailEntryId) property, if set.</span></span>
       - <span data-ttu-id="e1e9a-142">PR_DELETE_AFTER_SUBMIT (PidTagDeleteAfterSubmit) プロパティが TRUE に設定されている場合は、メッセージを削除します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-142">Deletes the message if the PR_DELETE_AFTER_SUBMIT (PidTagDeleteAfterSubmit) property has been set to TRUE.</span></span>
       - <span data-ttu-id="e1e9a-143">ロックされている場合、メッセージのロックを解除します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-143">Unlocks the message if it is locked.</span></span>
       - <span data-ttu-id="e1e9a-144">クライアントに返します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-144">Returns to the client.</span></span> <span data-ttu-id="e1e9a-145">メッセージ フローは、完了です。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-145">Message flow is complete.</span></span> 
   
2. <span data-ttu-id="e1e9a-146">トランスポートにメッセージ ・ ストアが密に結合されない、メッセージ ・ ストアに知られていたすべての受信者または NEEDS_SPOOLER フラグが設定されている場合は、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-146">Performs the following tasks if the message store is not tightly coupled to a transport, not all of the recipients were known to the message store, or the NEEDS_SPOOLER flag is set:</span></span>
    
   - <span data-ttu-id="e1e9a-147">**PR_SUBMIT_FLAGS**プロパティに SUBMITFLAG_PREPROCESS ビットを設定せず、送信キューにメッセージを配置します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-147">Puts the message in the outgoing queue without setting the SUBMITFLAG_PREPROCESS bit in the **PR_SUBMIT_FLAGS** property.</span></span> 
   - <span data-ttu-id="e1e9a-148">発信キューは、テーブルの通知を生成することによって変更された MAPI スプーラーに通知します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-148">Notifies the MAPI spooler that the outgoing queue has changed by generating a table notification.</span></span> 
   - <span data-ttu-id="e1e9a-149">クライアント、およびメッセージの流れに戻りますが、MAPI スプーラーが実行するタスクのセットを使用して続行します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-149">Returns to the client, and message flow continues with a set of tasks performed by the MAPI spooler.</span></span>
    
<span data-ttu-id="e1e9a-150">メッセージは、MAPI スプーラーによって処理されるには、メッセージ ストア プロバイダーは、メッセージの**PR_SUBMIT_FLAGS**プロパティを SUBMITFLAG_LOCKED に設定します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-150">When a message is to be handled by the MAPI spooler, the message store provider sets the message's **PR_SUBMIT_FLAGS** property to SUBMITFLAG_LOCKED.</span></span> <span data-ttu-id="e1e9a-151">SUBMITFLAG_LOCKED フラグは、MAPI スプーラーが、排他的使用のためのメッセージをロックしていることを示します。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-151">The SUBMITFLAG_LOCKED flag indicates that the MAPI spooler has locked the message for its exclusive use.</span></span> <span data-ttu-id="e1e9a-152">メッセージが 1 つ以上のプリプロセッサ関数を使用して、トランスポート プロバイダーが登録されている前処理を必要とする場合、 **PR_SUBMIT_FLAGS** SUBMITFLAG_PREPROCESS の他の値が設定されています。</span><span class="sxs-lookup"><span data-stu-id="e1e9a-152">The other value for **PR_SUBMIT_FLAGS,** SUBMITFLAG_PREPROCESS, is set when the message requires preprocessing by one or more preprocessor functions registered by a transport provider.</span></span> 
  

