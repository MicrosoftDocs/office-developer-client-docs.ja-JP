---
title: メッセージの送信 メッセージ ストア プロバイダー のタスク
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: acbfd3ae-bfdc-4103-bed2-6bcf7b9c448c
description: '最終更新日: 2015 年 3 月 9 日'
ms.openlocfilehash: de29707c7a257ea0e7ad658622d2a3054487f8b5
ms.sourcegitcommit: adcf409d56b6cb25be6117f09794defa41ad6c0f
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/14/2019
ms.locfileid: "37495307"
---
# <a name="sending-messages-message-store-provider-tasks"></a><span data-ttu-id="64255-103">メッセージの送信: メッセージ ストア プロバイダーのタスク</span><span class="sxs-lookup"><span data-stu-id="64255-103">Sending Messages: Message Store Provider Tasks</span></span>

<span data-ttu-id="64255-104">**適用対象**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="64255-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="64255-105">メッセージ ストア プロバイダーは、クライアントがメッセージの [IMessage::SubmitMessage](imessage-submitmessage.md) メソッドを呼び出す際に、メッセージ送信プロセスに関与します。</span><span class="sxs-lookup"><span data-stu-id="64255-105">A message store provider gets involved with the message sending process when a client calls the message's [IMessage::SubmitMessage](imessage-submitmessage.md) method.</span></span> <span data-ttu-id="64255-106">複数のメッセージを送信する場合、メッセージ ストアは、クライアントが SubmitMessage 呼び出しに使用した順序と同じ順序で送信 **する必要** があります。</span><span class="sxs-lookup"><span data-stu-id="64255-106">If multiple messages are to be sent, the message store must send them in the same order that the client used for its **SubmitMessage** calls.</span></span> 
  
<span data-ttu-id="64255-107">メッセージ ストア プロバイダーは、MAPI スプーラーを含めるかどうかを決定します。</span><span class="sxs-lookup"><span data-stu-id="64255-107">The message store provider determines whether or not to involve the MAPI spooler.</span></span> <span data-ttu-id="64255-108">メッセージ ストア プロバイダーが密に結合されていない場合、メッセージには前処理が必要です。または密に結合されたストアとトランスポートがすべての受信者を処理できない場合は、MAPI スプーラーを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="64255-108">If the message store provider is not tightly coupled, the message requires preprocessing, or the tightly coupled store and transport cannot handle all of the recipients, the MAPI spooler must be involved.</span></span> 
  
<span data-ttu-id="64255-109">次の手順では、メッセージを送信するためにメッセージ ストア プロバイダーに必要なタスクについて説明します。</span><span class="sxs-lookup"><span data-stu-id="64255-109">The following procedure describes the tasks required of a message store provider for sending a message.</span></span> 
  
<span data-ttu-id="64255-110">**IMessage::SubmitMessage では、メッセージ ストア プロバイダー**:</span><span class="sxs-lookup"><span data-stu-id="64255-110">**In IMessage::SubmitMessage, the message store provider**:</span></span>
  
1. <span data-ttu-id="64255-111">**メッセージ** の MSGFLAG_RESEND フラグが PR_MESSAGE_FLAGS ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) プロパティに設定されている場合は [、IMAPISupport::P repareSubmit](imapisupport-preparesubmit.md)を呼び出し、クライアントにエラーを返します。</span><span class="sxs-lookup"><span data-stu-id="64255-111">Calls [IMAPISupport::PrepareSubmit](imapisupport-preparesubmit.md) if the message has the MSGFLAG_RESEND flag set in its **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) property and returns any errors to the client.</span></span> <span data-ttu-id="64255-112">**PrepareSubmit** は **、PR_RECIPIENT_TYPEの受信者** リスト内の各受信者のプロパティ [(PidTagRecipientType)](pidtagrecipienttype-canonical-property.md)プロパティをチェックします。</span><span class="sxs-lookup"><span data-stu-id="64255-112">**PrepareSubmit** checks the **PR_RECIPIENT_TYPE** ([PidTagRecipientType](pidtagrecipienttype-canonical-property.md)) property of each recipient in the message's recipient list.</span></span>
    
   - <span data-ttu-id="64255-113">受信者が元のメッセージを受信しなかったことを示す MAPI_SUBMITTED フラグが設定されている場合 **、PrepareSubmit** はフラグをクリアし **、PR_RESPONSIBILITY** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) プロパティを TRUE に設定します。</span><span class="sxs-lookup"><span data-stu-id="64255-113">If the MAPI_SUBMITTED flag is set, indicating that the recipient did not receive the original message, **PrepareSubmit** clears the flag and sets the **PR_RESPONSIBILITY** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) property to TRUE.</span></span> 
    
   - <span data-ttu-id="64255-114">受信者が元のメッセージを受信したことを示す MAPI_SUBMITTED フラグが設定されていない場合 **、PrepareSubmit** は PR_RECIPIENT_TYPE プロパティを **MAPI_P1** に変更し **、PR_RESPONSIBILITY** プロパティを TRUE に設定し **、PrepareSubmit** によって生成されたエラーをクライアントに返します。</span><span class="sxs-lookup"><span data-stu-id="64255-114">If the MAPI_SUBMITTED flag is not set, indicating that the recipient did receive the original message, **PrepareSubmit** changes the **PR_RECIPIENT_TYPE** property to MAPI_P1 and sets the **PR_RESPONSIBILITY** property to TRUE and returns any error generated by **PrepareSubmit** to the client.</span></span> 
    
2. <span data-ttu-id="64255-115">メッセージの MSGFLAG_SUBMIT プロパティのフラグを **設定PR_MESSAGE_FLAGSします** 。</span><span class="sxs-lookup"><span data-stu-id="64255-115">Sets the MSGFLAG_SUBMIT flag in the message's **PR_MESSAGE_FLAGS** property.</span></span> 
    
3. <span data-ttu-id="64255-116">受信者テーブルに PR_RESPONSIBILITY 列が含まれています。メッセージを送信する責任がまだないトランスポートを示す FALSE に設定します。</span><span class="sxs-lookup"><span data-stu-id="64255-116">Makes sure that there is a column for **PR_RESPONSIBILITY** in the recipient table and sets it to FALSE to indicate that no transport has of yet assumed responsibility for transmitting the message.</span></span> 
    
4. <span data-ttu-id="64255-117">プロパティ[(PidTagClientSubmitTime)](pidtagclientsubmittime-canonical-property.md)プロパティPR_CLIENT_SUBMIT_TIME日付と時刻を設定します。 </span><span class="sxs-lookup"><span data-stu-id="64255-117">Sets the date and time of origination in the **PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)) property.</span></span>
    
5. <span data-ttu-id="64255-118">[IMAPISupport::ExpandRecips を次の場所に呼び出](imapisupport-expandrecips.md)します。</span><span class="sxs-lookup"><span data-stu-id="64255-118">Calls [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md) to:</span></span> 
    
   - <span data-ttu-id="64255-119">すべての個人用配布リストとカスタム受信者を展開し、変更された表示名を元の名前に置き換える。</span><span class="sxs-lookup"><span data-stu-id="64255-119">Expand all personal distribution lists and custom recipients and replace all changed display names with their original names.</span></span>
   - <span data-ttu-id="64255-120">重複する名前を削除します。</span><span class="sxs-lookup"><span data-stu-id="64255-120">Remove duplicate names.</span></span>
   - <span data-ttu-id="64255-121">必要な前処理を確認し、前処理が必要な場合は、NEEDS_PREPROCESSING フラグと **PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)) プロパティ (MAPI 用に予約されたプロパティ) を設定します。</span><span class="sxs-lookup"><span data-stu-id="64255-121">Check for any required preprocessing, and if preprocessing is required, set the NEEDS_PREPROCESSING flag and the **PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)) property, a property reserved for MAPI.</span></span> 
   - <span data-ttu-id="64255-122">メッセージ ストアNEEDS_SPOOLERトランスポートと密に結合され、すべての受信者を処理できない場合は、このフラグを設定します。</span><span class="sxs-lookup"><span data-stu-id="64255-122">Set the NEEDS_SPOOLER flag if the message store is tightly coupled with a transport and it cannot handle all of the recipients.</span></span> 
    
6. <span data-ttu-id="64255-123">メッセージ フラグが設定されている場合はNEEDS_PREPROCESSINGタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="64255-123">Performs the following tasks if the NEEDS_PREPROCESSING message flag is set:</span></span>
    
   - <span data-ttu-id="64255-124">メッセージを送信キューに入れ、SUBMITFLAG_PREPROCESS **(** [PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)) プロパティに PR_SUBMIT_FLAGS ビットを設定します。</span><span class="sxs-lookup"><span data-stu-id="64255-124">Puts the message in the outgoing queue with the SUBMITFLAG_PREPROCESS bit set in the **PR_SUBMIT_FLAGS** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)) property.</span></span>
   - <span data-ttu-id="64255-125">キューが変更された MAPI スプーラーに通知します。</span><span class="sxs-lookup"><span data-stu-id="64255-125">Notifies the MAPI spooler that the queue has changed.</span></span>
   - <span data-ttu-id="64255-126">クライアントに制御を返し、MAPI スプーラーでメッセージ フローを続行します。</span><span class="sxs-lookup"><span data-stu-id="64255-126">Returns control to the client, and message flow continues in the MAPI spooler.</span></span> 
   - <span data-ttu-id="64255-127">MAPI スプーラーは、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="64255-127">The MAPI spooler performs the following tasks:</span></span>
     - <span data-ttu-id="64255-128">IMsgStore::SetLockState を呼び出してメッセージをロックします。</span><span class="sxs-lookup"><span data-stu-id="64255-128">Locks the message by calling IMsgStore::SetLockState.</span></span> 
     - <span data-ttu-id="64255-129">登録の順序ですべての前処理関数を呼び出して、必要な前処理を実行します。</span><span class="sxs-lookup"><span data-stu-id="64255-129">Performs the needed preprocessing by calling all of the preprocessing functions in the order of registration.</span></span> <span data-ttu-id="64255-130">トランスポート プロバイダーは IMAPISupport::RegisterPreprocessor を呼び出して、前処理関数を登録します。</span><span class="sxs-lookup"><span data-stu-id="64255-130">Transport providers call IMAPISupport::RegisterPreprocessor to register preprocessing functions.</span></span> 
     - <span data-ttu-id="64255-131">開いているメッセージで IMessage::SubmitMessage を呼び出して、前処理が完了したとメッセージ ストアに示します。</span><span class="sxs-lookup"><span data-stu-id="64255-131">Calls IMessage::SubmitMessage on the open message to indicate to the message store that preprocessing is complete.</span></span>

<br/>

<span data-ttu-id="64255-132">次の 2 つの手順は、前処理がない場合と、MAPI スプーラーが前処理が行われる場合に **SubmitMessage** を呼び出す場合に、クライアント プロセスで発生します。</span><span class="sxs-lookup"><span data-stu-id="64255-132">The following two steps occur in the client process if there was no preprocessing, and when the MAPI spooler calls **SubmitMessage** if there was preprocessing.</span></span> 

<span data-ttu-id="64255-133">**メッセージ ストア プロバイダー**:</span><span class="sxs-lookup"><span data-stu-id="64255-133">**The message store provider**:</span></span>

1. <span data-ttu-id="64255-134">メッセージ ストアがトランスポートに緊密に結合され、NEEDS_SPOOLER フラグが [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md)から返された場合は、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="64255-134">Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):</span></span>
    
   - <span data-ttu-id="64255-135">処理できる受信者を処理します。</span><span class="sxs-lookup"><span data-stu-id="64255-135">Handles any recipients that it can handle.</span></span>
   - <span data-ttu-id="64255-136">処理する **PR_RESPONSIBILITY** のプロパティを TRUE に設定します。</span><span class="sxs-lookup"><span data-stu-id="64255-136">Sets the **PR_RESPONSIBILITY** property to TRUE for any recipients that it handles.</span></span> 
   - <span data-ttu-id="64255-137">この緊密に結合されたストアとトランスポートに対してすべての受信者が知られている場合は、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="64255-137">Performs the following tasks if all recipients are known to this tightly coupled store and transport:</span></span>
     - <span data-ttu-id="64255-138">メッセージが前処理された場合、またはメッセージ ストア プロバイダーが MAPI スプーラーにメッセージ処理を完了する必要がある場合は、IMAPISupport::CompleteMsg を呼び出して、メッセージング フックを呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="64255-138">Calls IMAPISupport::CompleteMsg if the message was preprocessed or the message store provider wants the MAPI spooler to complete message processing which is recommended so that messaging hooks can be invoked.</span></span> <span data-ttu-id="64255-139">次の手順で説明するように、メッセージ フローは MAPI スプーラーで続行されます。</span><span class="sxs-lookup"><span data-stu-id="64255-139">Message flow continues with the MAPI spooler as described in the following procedure.</span></span>  
     - <span data-ttu-id="64255-140">メッセージが前処理されていないか、メッセージ ストア プロバイダーが MAPI スプーラーにメッセージ処理を完了しない場合は、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="64255-140">Performs the following tasks if the message was not preprocessed or the message store provider does not want the MAPI spooler to complete message processing:</span></span>
       - <span data-ttu-id="64255-141">設定されている場合は、PR_SENTMAIL_ENTRYID (PidTagSentMailEntryId) プロパティのエントリ識別子によって識別されるフォルダーにメッセージをコピーします。</span><span class="sxs-lookup"><span data-stu-id="64255-141">Copies the message to the folder identified by the entry identifier in the PR_SENTMAIL_ENTRYID (PidTagSentMailEntryId) property, if set.</span></span>
       - <span data-ttu-id="64255-142">プロパティ (PidTagDeleteAfterSubmit) プロパティが TRUE にPR_DELETE_AFTER_SUBMITメッセージを削除します。</span><span class="sxs-lookup"><span data-stu-id="64255-142">Deletes the message if the PR_DELETE_AFTER_SUBMIT (PidTagDeleteAfterSubmit) property has been set to TRUE.</span></span>
       - <span data-ttu-id="64255-143">メッセージがロックされている場合は、メッセージのロックを解除します。</span><span class="sxs-lookup"><span data-stu-id="64255-143">Unlocks the message if it is locked.</span></span>
       - <span data-ttu-id="64255-144">クライアントに返します。</span><span class="sxs-lookup"><span data-stu-id="64255-144">Returns to the client.</span></span> <span data-ttu-id="64255-145">メッセージ フローが完了しました。</span><span class="sxs-lookup"><span data-stu-id="64255-145">Message flow is complete.</span></span> 
   
2. <span data-ttu-id="64255-146">メッセージ ストアがトランスポートに緊密に結合されていない場合、すべての受信者がメッセージ ストアに知られているか、NEEDS_SPOOLER フラグが設定されている場合は、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="64255-146">Performs the following tasks if the message store is not tightly coupled to a transport, not all of the recipients were known to the message store, or the NEEDS_SPOOLER flag is set:</span></span>
    
   - <span data-ttu-id="64255-147">メッセージを送信キューに入れ、SUBMITFLAG_PREPROCESS プロパティに **PR_SUBMIT_FLAGSします。**</span><span class="sxs-lookup"><span data-stu-id="64255-147">Puts the message in the outgoing queue without setting the SUBMITFLAG_PREPROCESS bit in the **PR_SUBMIT_FLAGS** property.</span></span> 
   - <span data-ttu-id="64255-148">テーブル通知を生成して、送信キューが変更された MAPI スプーラーに通知します。</span><span class="sxs-lookup"><span data-stu-id="64255-148">Notifies the MAPI spooler that the outgoing queue has changed by generating a table notification.</span></span> 
   - <span data-ttu-id="64255-149">クライアントに戻り、メッセージ フローは MAPI スプーラーによって実行される一連のタスクを続行します。</span><span class="sxs-lookup"><span data-stu-id="64255-149">Returns to the client, and message flow continues with a set of tasks performed by the MAPI spooler.</span></span>
    
<span data-ttu-id="64255-150">MAPI スプーラーでメッセージを処理する場合、メッセージ ストア プロバイダーは、メッセージの PR_SUBMIT_FLAGS **プロパティを** SUBMITFLAG_LOCKED。</span><span class="sxs-lookup"><span data-stu-id="64255-150">When a message is to be handled by the MAPI spooler, the message store provider sets the message's **PR_SUBMIT_FLAGS** property to SUBMITFLAG_LOCKED.</span></span> <span data-ttu-id="64255-151">このSUBMITFLAG_LOCKEDは、MAPI スプーラーがメッセージを排他的に使用するためにロックした状態を示します。</span><span class="sxs-lookup"><span data-stu-id="64255-151">The SUBMITFLAG_LOCKED flag indicates that the MAPI spooler has locked the message for its exclusive use.</span></span> <span data-ttu-id="64255-152">PR_SUBMIT_FLAGS **SUBMITFLAG_PREPROCESS** のもう 1 つの値は、メッセージがトランスポート プロバイダーによって登録された 1 つ以上のプリプロセッサ関数によって前処理を必要とする場合に設定されます。</span><span class="sxs-lookup"><span data-stu-id="64255-152">The other value for **PR_SUBMIT_FLAGS,** SUBMITFLAG_PREPROCESS, is set when the message requires preprocessing by one or more preprocessor functions registered by a transport provider.</span></span> 
  

