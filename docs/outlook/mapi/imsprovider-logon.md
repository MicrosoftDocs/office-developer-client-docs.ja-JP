---
title: IMSProviderLogon
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
ms.topic: reference
ms.prod: office-online-server
localization_priority: Normal
api_name:
- IMSProvider.Logon
api_type:
- COM
ms.assetid: 890d9cbe-3570-4cf0-aeae-667c0e5ba181
description: '�ŏI�X�V��: 2011�N7��23��'
ms.openlocfilehash: 9c7f62c69c7a06f7ca0e4bfddcf789cddc536ea6
ms.sourcegitcommit: ef717c65d8dd41ababffb01eafc443c79950aed4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/04/2018
ms.locfileid: "25386566"
---
# <a name="imsproviderlogon"></a>IMSProvider::Logon

  
  
**適用対象**: Outlook 2013 | Outlook 2016 
  
MAPI メッセージ ストア プロバイダーのインスタンスを 1 つにログに記録します。
  
```cpp
HRESULT Logon(
  LPMAPISUP lpMAPISup,
  ULONG_PTR ulUIParam,
  LPSTR lpszProfileName,
  ULONG cbEntryID,
  LPENTRYID lpEntryID,
  ULONG ulFlags,
  LPCIID lpInterface,
  ULONG FAR * lpcbSpoolSecurity,
  LPBYTE FAR * lppbSpoolSecurity,
  LPMAPIERROR FAR * lppMAPIError,
  LPMSLOGON FAR * lppMSLogon,
  LPMDB FAR * lppMDB
);
```

## <a name="parameters"></a>パラメーター

 _lpMAPISup_
  
> [in]現在の MAPI へのポインターは、メッセージ ・ ストアのオブジェクトをサポートします。
    
 _ulUIParam_
  
> [in]ダイアログ ボックスまたはウィンドウの親ウィンドウへのハンドルを表示します。 
    
 _lpszProfileName_
  
> [in]ストア プロバイダーへのログオンに使用されているプロファイルの名前を含む文字列へのポインター。 この文字列のダイアログ ボックスに表示される、ログ ファイルに書き出されます。 または単に無視されます。 _UlFlags_パラメーターに MAPI_UNICODE フラグが設定されている場合は、Unicode 形式である必要があります。 
    
 _cbEntryID_
  
> [in]_LpEntryID_パラメーターで指定されたエントリの識別子のバイト単位のサイズです。 
    
 _lpEntryID_
  
> [in]メッセージ ・ ストアのエントリの識別子へのポインター。 _LpEntryID_に**null**を渡す場合、メッセージ ストアが選択されていないと、メッセージ ストアを選択するユーザーを有効にする] ダイアログ ボックスを表示できることを示します。 
    
 _ulFlags_
  
> [in]ログオンを実行する方法を制御するフラグのビットマスクです。 次のフラグを設定することができます。
    
MAPI_DEFERRED_ERRORS 
  
> 呼び出しは、基になるオブジェクトが呼び出し元の実装に使用可能でない場合でも、成功するために許可されています。 オブジェクトが使用できない場合は、オブジェクトへの後続の呼び出しはエラーを発生させる可能性があります。
    
MAPI_UNICODE 
  
> 渡された文字列は、Unicode 形式では。 MAPI_UNICODE が設定されていない場合は、ANSI 形式の文字列です。
    
MDB_NO_DIALOG 
  
> ログオン ダイアログ ボックスが表示できないようにします。 このフラグが設定されている場合、ログオンが成功しない場合、エラー値 MAPI_E_LOGON_FAILED が返されます。 このフラグが設定されていない場合、メッセージ ストア プロバイダーはユーザー名またはパスワード、またはストアへの接続を確立するために必要なその他のアクションを実行するのには、ディスクを挿入するのにを修正するを求めることができます。
    
MDB_NO_MAIL 
  
> メールの送受信のメッセージ ・ ストアを使用してくださいできません。 フラグは、このメッセージ ・ ストアが開かれることを MAPI スプーラーに通知するためにない MAPI を通知します。 このフラグが設定されて「メッセージ ・ ストアは、トランスポート プロバイダーと密接に関連がある場合は、プロバイダーが[IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md)メソッドを呼び出す必要はありません。 
    
MDB_TEMPORARY 
  
> ストアのログ、[プロファイル] セクションから情報をプログラムによって取得できるように、使用しない] ダイアログ ボックスの。 このフラグは、ストアがメッセージ ストアのテーブルに追加されないことと、ストアを固定化することはできません、MAPI を指示します。 このフラグが設定されている場合、メッセージ ストア プロバイダーでは、 [IMAPISupport::ModifyProfile](imapisupport-modifyprofile.md)メソッドを呼び出す必要はありません。 
    
MDB_WRITE 
  
> 要求の読み取り/書き込みのアクセス許可
    
 _lpInterface_
  
> [in]メッセージ ・ ストアへのログオン用のインターフェイス id (IID) へのポインター。 **Null**を渡すには、メッセージ ・ ストア ( [IMsgStore](imsgstoreimapiprop.md)) の MAPI インターフェイスが返されることを示します。 などに対する (IID_IMAPIProp) は、メッセージ ストアの適切なインターフェイスの識別子を_lpInterface_パラメーターを設定することもできます。 
    
 _lpcbSpoolSecurity_
  
> [out]ストア プロバイダーが、 _lppbSpoolSecurity_パラメーターの検証データのバイト単位のサイズを返します。 変数へのポインター。 
    
 _lppbSpoolSecurity_
  
> [out]返される検証データへのポインターへのポインター。 [IMSProvider::SpoolerLogon](imsprovider-spoolerlogon.md)メソッドは、メッセージ ストア プロバイダーとして同じストアに、MAPI スプーラーをログインできるように、この検証データが用意されています。 
    
 _lppMAPIError_
  
> [out]返された[MAPIERROR](mapierror.md)構造体、存在する場合エラーが発生するバージョン、コンポーネント、およびコンテキストの情報が含まれているへのポインターへのポインター。 取得する**MAPIERROR**構造体がない場合、 _lppMAPIError_パラメーターを**null**に設定できます。 
    
 _lppMSLogon_
  
> [out]メッセージへのポインターへのポインターでは、MAPI にログオンするためのログオン オブジェクトを格納します。
    
 _lppMDB_
  
> [out]メッセージへのポインターへのポインターでは、MAPI スプーラーとクライアント アプリケーションにログオンするためのオブジェクトを格納します。
    
## <a name="return-value"></a>戻り値

S_OK 
  
> �ʘb���������A�\�������l�܂��͒l���Ԃ���܂��B
    
MAPI_E_FAILONEPROVIDER 
  
> このプロバイダーがログオンできないが、このエラーには、サービスが無効にする必要があります。 
    
MAPI_E_LOGON_FAILED 
  
> ログオン セッションを確立できませんでした。
    
MAPI_E_UNCONFIGURED 
  
> プロファイルにログオンを完了するのに十分な情報が含まれていません。 この値が返された場合は、MAPI メッセージ ストア プロバイダーのメッセージ サービスのエントリ ポイント関数を呼び出します。
    
MAPI_E_USER_CANCEL 
  
> ユーザー操作がキャンセルされました、通常ダイアログ ボックスで [**キャンセル**] ボタンをクリックするとします。 
    
MAPI_E_UNKNOWN_CPID 
  
> サーバーは、クライアントのコード ページをサポートするために構成されていません。
    
MAPI_E_UNKNOWN_LCID 
  
> サーバーは、クライアントのロケール情報をサポートするために構成されていません。
    
MAPI_W_ERRORS_RETURNED 
  
> 呼び出しが成功したが、メッセージ ストア プロバイダーが使用可能なエラー情報を持ちます。 この警告が返されると、呼び出しを成功として処理する必要があります。 この警告をテストするには、 **HR_FAILED**マクロを使用します。 詳細については、[エラーを処理するためのマクロの使用](using-macros-for-error-handling.md)を参照してください。 プロバイダーからエラー情報を取得するには、 [IMAPISession::GetLastError](imapisession-getlasterror.md)メソッドを呼び出します。 
    
## <a name="remarks"></a>備考

MAPI は、メッセージ ストアへのアクセスを取得するために必要な処理の大部分を実行する**IMSProvider::Logon**メソッドを呼び出します。 メッセージ ストア プロバイダーは、特定のストアにアクセスし、MAPI スプーラーとクライアント アプリケーションがログオンすることができる_lppMDB_パラメーターにはメッセージ ストアのオブジェクトを返すために必要なユーザー資格情報を検証します。 
  
返されるメッセージ ストア] オブジェクトのクライアントと、MAPI スプーラーの使用だけでなく、プロバイダーは、開かれているストアを制御することで使用する mapi メッセージ ストアのログオン オブジェクトを返します。 メッセージ ストアのログオン オブジェクトと、メッセージ ストアのオブジェクトと緊密にリンクするメッセージ ストア プロバイダーの内部ため、それぞれが他方に影響ことができます。 ストア オブジェクトとログオン オブジェクトの使用は、する必要があります。オブジェクトが 2 つのインターフェイスを公開する 1 つのオブジェクトであるかのように動作するよう、ログオン オブジェクトとストア オブジェクトとの間の 1 対 1 対応がかかることがあります。 2 つのオブジェクトも作成してくださいと連携して解放された一緒。 
  
MAPI サポート オブジェクトが表示され、MAPI によって作成され、 _lpMAPISup_パラメーターでは、プロバイダーに渡されるプロバイダーを必要とする MAPI の関数へのアクセスを提供します。 保存して、プロファイル情報を取得し、アドレス帳にアクセスなどの機能が含まれます。 _LpMAPISup_ポインターを開かれているストアごとに異なることができます。 処理を呼び出すと、ログオンした後、メッセージ ストア、ストア プロバイダーは、そのストアに固有の_lpMAPISup_変数を利用できます。 **ログオン**するすべての呼び出し、メッセージ ・ ストアを開き、メッセージ ストアのログオン オブジェクトの作成に成功すると、プロバイダーはストア ログオン オブジェクトでの MAPI サポート オブジェクトへのポインターを保存する必要があり。 への参照を追加するのには[IUnknown::AddRef](https://msdn.microsoft.com/library/ms691379%28v=VS.85%29.aspx)メソッドを呼び出す必要があります。サポート オブジェクト。 
  
**ログオン**呼び出し中に、プロバイダーがダイアログ ボックスを表示する場合は、 _ulUIParam_パラメーターを使用してください。 ただし、 _ulFlags_に MDB_NO_DIALOG フラグが含まれている場合のダイアログ ボックスが表示されない必要があります。 ユーザー インターフェイスが呼び出される必要がありますが、 _ulFlags_では許可されていない場合、または何らかの理由でユーザー インターフェイスを表示できない場合は、プロバイダーは、MAPI_E_LOGON_FAILED を返す必要があります。 **ログオン**ダイアログ ボックスを表示するユーザーのログオンをキャンセルする場合は、通常、ダイアログ ボックスの [**キャンセル**] ボタンをクリックすると、プロバイダー返す必要があります MAPI_E_USER_CANCEL。 
  
_LpEntryID_パラメーターを**null**にするか、ラップが解除されたストア エントリ id このメッセージを格納する以前に作成] をポイントします。 _LpEntryID_は、ラップ解除済みのエントリ id をポイントしている場合、エントリ id はいくつかの場所のいずれかから。 
  
- ストア プロバイダーは、以前にラップされ、 **PR_ENTRYID** ([PidTagEntryId](pidtagentryid-canonical-property.md)) のプロパティとプロファイルのセクションを記述するエントリの識別子を指定できます。
    
- プロバイダーは、以前にラップされ、 **PR_STORE_ENTRYID** ([PidTagStoreEntryId](pidtagstoreentryid-canonical-property.md)) のプロパティとして呼び出し側のクライアントに返されるエントリ識別子を指定できます。 
    
- プロバイダーが以前にラップされ、 **PR_ENTRYID**オブジェクトのプロパティ、メッセージ ストアとして呼び出し側のクライアントに返されますエントリ id を指定できます。 
    
ような場合も、ことはのエントリ id が現在使用されているよりも別のコンピューターで作成されたものであること。
  
_LpEntryID_が**null**でないすべての情報を識別し、メッセージ ・ ストアを検索するために必要に含めます。 ネットワーク ボリュームの名前、電話番号、ユーザーのアカウント名、およびように、この情報を含めることができます。 エントリの識別子のデータを使用してストアに接続できない場合、ストア プロバイダーによってユーザーがストアを開くことを選択できるダイアログ ボックスが表示されます。 ダイアログ ボックスはサーバーの名前が変更された、アカウント名が変更された、またはネットワークの一部が使用できない場合などは、必要になる可能性があります。
  
_LpEntryID_が**null**の場合は、メッセージ ・ ストアを使用するにはまだ選択されていません。 プロバイダーは、ストアを指定する別の方法をサポートしている場合、ダイアログ ボックスを表示せず、ストアにアクセスできます。 プロバイダーは、初期設定ファイルをチェックできますなど、構成で、または、メッセージ サービスのプロファイルのセクションに配置された追加のプロパティを探すことができます。
  
プロバイダーが検出された場合に必要な情報が、プロファイルに含まれないすべては MAPI_E_UNCONFIGURED を返します。 MAPI は、ストアを選択するか、いずれかの作成にも、ユーザーを有効にするプロバイダーのメッセージ サービス エントリ ポイント関数を呼び出すし、として、アカウント名とパスワードを入力するために必要な. MAPI は、新しい店舗の新しいプロファイルのセクションを自動的に作成されます。一時的または永続的に追加された方法によって、この新しいプロファイル セクションができます。 ストア プロバイダーは、 **IMAPISupport::ModifyProfile**メソッドを呼び出し、プロファイルのセクションを新しい永続的ななりストアは、 [IMAPISession::GetMsgStoresTable](imapisession-getmsgstorestable.md)メソッドによって返されるメッセージ ストアの一覧に追加されます。 
  
_LpInterface_パラメーターでは、新しく開かれたストア オブジェクトに必要なインターフェイスの IID を指定します。 _LpInterface_に**null**を渡す場合は、MAPI メッセージ ストアのインターフェイス、 **IMsgStore**が必要であることを指定します。 **IMsgStore**する必要がある指定も、IID_IMsgStore、メッセージ ストア オブジェクトを渡します。 に対するが_lpInterface_に渡された場合、プロバイダーがから派生した任意のインターフェイスを使用して、ストアを開く必要があります[IUnknown](https://msdn.microsoft.com/library/ms680509%28v=VS.85%29.aspx)は、プロバイダーに最適です (この場合も、通常**IMsgStore**)。 に対するが渡されると、呼び出し元の実装メソッドを使用して[IUnknown::QueryInterface](https://msdn.microsoft.com/library/ms682521%28v=VS.85%29.aspx)ストアを開く操作が成功した後は、インタ フェースを選択します。 
  
**IMSProvider::Logon**の呼び出しは、ストア プロバイダーは、ダイアログ ボックスを表示するのには同一のストアにログオンするため、MAPI スプーラーを許可するのには、ストアにアクセスするための資格情報、ストアへのパスなどのための十分な情報を返す必要があります。 _LpcbSpoolSecurity_と_lppbSpoolSecurity_のパラメーターは、この情報を返すために使用されます。 プロバイダーは、 [MSProviderInit](msproviderinit.md)関数の_lpfAllocateBuffer_パラメーター内のバッファーにポインターを渡すことによってこのデータのメモリを割り当てますプロバイダーは、このバッファーのサイズを_lpcbSpoolSecurity_に配置されます。 
  
MAPI では、該当する場合は、このバッファーを解放します。 単独でのプロファイル セクションの情報ストアを MAPI スプーラーでのログオンを実行できる場合はプロバイダーが_lppbSpoolSecurity_と_lpcbSpoolSecurity_での情報のサイズを 0 に null を返します。 ストアのログオンに別のプロセスの一部として MAPI スプーラー ログオンが行われました。渡された情報を格納しているバッファーは、プロセス間でコピーを取得するため、MAPI スプーラ プロセスに、ストア プロバイダーのプロセスの場合と同じ場所にメモリ内に可能性がありますできません。 したがって、プロバイダーは必要はありませんこのバッファーにアドレスを配置します。 MAPI スプーラーのログオンの詳細については、 [IMSProvider::SpoolerLogon](imsprovider-spoolerlogon.md)メソッドを参照してください。 
  
ストア プロバイダーのほとんどは、保存、およびユーザーの資格情報とオプションを取得する_lpMAPISup_パラメーターで渡されたサポート オブジェクトの[IMAPISession::OpenProfileSection](imapisession-openprofilesection.md)メソッドを使用します。 **OpenProfileSection**では、ストア プロバイダーは、[プロファイル] セクションで任意の追加情報を保存し、特定のリソースに関連付けることができるようにします。 たとえば、ストア プロバイダーは、ユーザー アカウント名とリソースとすべてのパス、またはそのリソースへのアクセスに必要なその他の情報に関連付けられているパスワードを保存できます。 
  
0x67FF から 0x6600 のプロパティ識別子とプロパティは、セキュリティで保護されたプロパティの独自の使用プロファイルのセクションで、プライベート データを格納するためにプロバイダーに使用可能です。 プロファイル セクション オブジェクトのプロパティの使用方法に関する詳細についてを参照してください、 [IProfSect: IMAPIProp](iprofsectimapiprop.md)メソッドです。 
  
0x67FF から 0x6600 の識別子を持つプロパティのプライベート データには、ストア プロバイダーは、プロファイル セクションのプロパティに**PR_DISPLAY_NAME** ([PidTagDisplayName](pidtagdisplayname-canonical-property.md)) の情報を提供する必要があります。 プロバイダー自体の表示名**PR_DISPLAY_NAME**に配置する必要があります-ので、他のユーザーからこのメッセージ ・ ストアを見分けることは、ユーザーに表示されている識別文字列 (たとえば、[Microsoft 個人用インフォメーション ストア") ことがありますがアクセスします。宛先。 **PR_DISPLAY_NAME**には、一般的にサーバー名、ユーザー アカウント名、またはパスが含まれます。 
  
いくつかのプロファイル セクションのプロパティがメッセージ ストア テーブルに表示されます。他のユーザーは、セットアップ、インストール、および MAPI サブシステムの構成中に表示されます。 プロバイダーは、通常、まだではない保存された認証情報や個人情報、およびプロパティ情報が変更されたことが見つかると新しいプロファイル セクションの両方表示されているプロパティの情報を提供します。 プロファイル セクションの詳細については、 [IMAPISupport::OpenProfileSection](imapisupport-openprofilesection.md)を参照してください。
  
正常にログインした後ユーザー、および MAPI に戻る前に、ストア プロバイダーはリソースの [状態] 行のプロパティの配列を作成し、 [IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md)メソッドを呼び出す必要があります。 
  
 既に開いている現在の MAPI セッションのメッセージ ストアを開く**ログオン**呼び出しでは、前述の処理のほとんどを省略します。 これらの呼び出しはないステータス行を作成、メッセージ ストアのログオン オブジェクトを返す、MAPI サポート オブジェクトの**AddRef**を呼び出すまたは MAPI スプーラーのログオン用のデータを返します。 これらの呼び出しは S_OK を返すし、要求されたインターフェイスを使用してメッセージ ストア オブジェクトを返します。 
  
このような呼び出しを検出するためにプロバイダーする必要があります一覧を管理ストアのメッセージ ストア プロバイダー オブジェクトにこのプロバイダーのオブジェクトは既に開かれています。 **ログオン**呼び出しを処理するには、プロバイダーする必要がありますこの開いている店舗の一覧をスキャンし、上にログを記録するストアが既に開いているかどうかを確認します。 場合は、ユーザーの資格情報をチェックする必要はありませんし、ダイアログ ボックスの表示は避けて、可能な場合。 ダイアログ ボックスが表示される必要があります、プロバイダーは、ストアが 2 回目を開いているかどうかを確認する返された情報をください。 さらに、プロバイダーを確認する重複開口部**ログオン**呼び出しの先頭に_lpEntryID_を使用して処理します。 
  
標準は、開いているストアにアクセスする**ログイン**の呼び出しの処理は次のとおりです。 
  
1. ストア プロバイダーは、要求された新しいインターフェイスは、既存のストアに格納するためのインターフェイスと同じ場合、既存のストア オブジェクトの**AddRef**を呼び出します。 それ以外の場合、新しいインターフェイスを取得するのには、 **QueryInterface**が呼び出されます。 ストアが、新しいインターフェイスをサポートしていない場合、プロバイダーは、エラー値 MAPI_E_INTERFACE_NOT_SUPPORTED を返す必要があります。 
    
2. プロバイダーは、 _lppMDB_内の既存のストア オブジェクトの必須インターフェイスへのポインターを返します。
    
3. プロバイダーは、 _lppMSLogon_に**null**を返します。
    
4. プロバイダーは、呼び出しで渡されたサポート オブジェクトのプロファイルを開かないでください。 さらに、その必要がありますプロバイダーの一意の識別子を登録、登録、ステータス行やログオン データを MAPI スプーラーに返します。
    
5. プロバイダーない**AddRef**を呼び出しますサポート オブジェクトのオブジェクトへのポインターする必要がないためです。 
    
可能な限り、プロバイダーは、適切なエラーを返す必要があり、容易に何かできなかった理由を判断する際にユーザーの負担を大幅にこれを行うために、**ログオン**の呼び出しに対して文字列を警告します。 これらの文字列を返すには、プロバイダーは、 **MAPIERROR**構造体のメンバーを設定します。 MAPI を使用していると、それがプロバイダーによって返された場合は、 **MAPIERROR**構造体を解放します。 
  
_LpfAllocateBuffer_ **MSProviderInit**の呼び出しに渡されたバッファーを使用してこの**MAPIERROR**の構造体のメモリの割り当てする必要があります。 何らかのエラーが返された構造体に含まれる文字列が Unicode 形式である必要があります MAPI_UNICODE は、それ以外の場合の**ログオン** _ulFlags;_ で設定されている場合、ANSI 文字に設定されます。 
  
**ログオン**から返されるエラー値のほとんどを MAPI には、障害のあるプロバイダーが所属するメッセージ サービスが無効になります。 MAPI は MAPI セッションの有効期間にこれらのサービスに属するすべてのプロバイダーを呼び出しません。 対照的に、**ログオン**のログオンから MAPI_E_FAILONEPROVIDER のエラー値が返されると、MAPI は無効メッセージ サービス プロバイダーが所属します。 セッションの有効期間全体のサービスを無効にすることを保証しないというエラーが発生した場合、**ログオン**は MAPI_E_FAILONEPROVIDER を返す必要があります。 などのユーザー インターフェイスの表示を許可しないし、必要なパスワードが使用できない場合、プロバイダーはこのエラーを返すことがあります。 
  
プロバイダーは、そのログオンから MAPI_E_UNCONFIGURED を返します、MAPI は、プロバイダーのメッセージ サービスのエントリ関数を呼び出し、ログオンを再試行してください。 MAPI では、サービス自体を設定する機会を提供するコンテキストとして MSG_SERVICE_CONFIGURE を渡します。 ログオン時にユーザー インターフェイスを許可するクライアントを選択すると、構成情報を入力できるように、サービスは、[設定] プロパティ シートを表示できます。
  
## <a name="see-also"></a>関連項目



[IMAPISession::GetMsgStoresTable](imapisession-getmsgstorestable.md)
  
[IMAPISession::OpenMsgStore](imapisession-openmsgstore.md)
  
[IMAPISession::OpenProfileSection](imapisession-openprofilesection.md)
  
[IMAPISupport::ModifyProfile](imapisupport-modifyprofile.md)
  
[IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md)
  
[IMsgStore: IMAPIProp](imsgstoreimapiprop.md)
  
[IMSProvider::SpoolerLogon](imsprovider-spoolerlogon.md)
  
[IProfSect : IMAPIProp](iprofsectimapiprop.md)
  
[MAPIERROR](mapierror.md)
  
[MSProviderInit](msproviderinit.md)
  
[IMSProvider : IUnknown](imsprovideriunknown.md)

