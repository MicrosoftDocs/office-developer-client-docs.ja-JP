---
title: IMSProviderLogon
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
ms.topic: reference
ms.prod: office-online-server
localization_priority: Normal
api_name:
- IMSProvider.Logon
api_type:
- COM
ms.assetid: 890d9cbe-3570-4cf0-aeae-667c0e5ba181
description: '最終更新日: 2011 年 7 月 23 日'
ms.openlocfilehash: 9c7f62c69c7a06f7ca0e4bfddcf789cddc536ea6
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/23/2019
ms.locfileid: "32309668"
---
# <a name="imsproviderlogon"></a>IMSProvider::Logon

  
  
**適用対象**: Outlook 2013 | Outlook 2016 
  
メッセージストアプロバイダーの1つのインスタンスに MAPI を記録します。
  
```cpp
HRESULT Logon(
  LPMAPISUP lpMAPISup,
  ULONG_PTR ulUIParam,
  LPSTR lpszProfileName,
  ULONG cbEntryID,
  LPENTRYID lpEntryID,
  ULONG ulFlags,
  LPCIID lpInterface,
  ULONG FAR * lpcbSpoolSecurity,
  LPBYTE FAR * lppbSpoolSecurity,
  LPMAPIERROR FAR * lppMAPIError,
  LPMSLOGON FAR * lppMSLogon,
  LPMDB FAR * lppMDB
);
```

## <a name="parameters"></a>パラメーター

 _lpMAPISup_
  
> 順番メッセージストアの現在の MAPI サポートオブジェクトへのポインター。
    
 _uluiparam_
  
> 順番このメソッドが表示する任意のダイアログボックスまたはウィンドウの親ウィンドウへのハンドル。 
    
 _lpszprofilename_
  
> 順番ストアプロバイダーのログオンに使用されているプロファイルの名前を含む文字列へのポインター。 この文字列は、ダイアログボックスに表示したり、ログファイルに書き込んだたり、単に無視したりできます。 MAPI_UNICODE フラグが_ulflags_パラメーターで設定されている場合は、Unicode 形式である必要があります。 
    
 _cbEntryID_
  
> 順番_lな tryid_パラメーターで指定されたエントリ識別子のサイズ (バイト単位)。 
    
 _lて tryid_
  
> 順番メッセージストアのエントリ識別子へのポインター。 _l記憶 tryid_で**null**を渡すことは、メッセージストアがまだ選択されておらず、ユーザーがメッセージストアを選択できるようにするダイアログボックスが表示されることを示します。 
    
 _ulFlags_
  
> 順番ログオンの実行方法を制御するフラグのビットマスク。 次のフラグを設定できます。
    
MAPI_DEFERRED_ERRORS 
  
> 呼び出し元のオブジェクトが呼び出し側の実装で使用できない場合でも、呼び出しを成功させることができます。 オブジェクトが使用できない場合は、その後のオブジェクトの呼び出しでエラーが発生する可能性があります。
    
MAPI_UNICODE 
  
> 渡された文字列は Unicode 形式です。 MAPI_UNICODE が設定されていない場合、文字列は ANSI 形式になります。
    
MDB_NO_DIALOG 
  
> ログオンダイアログボックスを表示しないようにします。 このフラグが設定されている場合は、ログオンが失敗した場合にエラー値 MAPI_E_LOGON_FAILED が返されます。 このフラグが設定されていない場合、メッセージストアプロバイダーはユーザーに対して、名前またはパスワードを修正するか、ディスクを挿入するか、またはストアへの接続を確立するために必要なその他の操作を実行するように求めることができます。
    
MDB_NO_MAIL 
  
> メールを送受信するためにメッセージストアを使用することはできません。 このフラグは、mapi スプーラーにこのメッセージストアが開かれていることを通知しないように mapi に通知します。 このフラグが設定されており、メッセージストアがトランスポートプロバイダーと密接に結合されている場合、プロバイダーは[imapisupport:: SpoolerNotify](imapisupport-spoolernotify.md)メソッドを呼び出す必要はありません。 
    
MDB_TEMPORARY 
  
> ストアにログを記録して、ダイアログボックスを使用せずに、プロファイルセクションからプログラムによって情報を取得できるようにします。 このフラグは、ストアがメッセージストアテーブルに追加されず、ストアが永続的に作成できないことを MAPI に指示します。 このフラグが設定されている場合、メッセージストアプロバイダーは[imapisupport:: modifyprofile](imapisupport-modifyprofile.md)メソッドを呼び出す必要はありません。 
    
MDB_WRITE 
  
> 読み取り/書き込みアクセス許可を要求します。
    
 _lpinterface_
  
> 順番ログオンするメッセージストアのインターフェイス識別子 (IID) へのポインター。 **null**を渡すと、メッセージストア ( [IMsgStore](imsgstoreimapiprop.md)) の MAPI インターフェイスが返されます。 _lpinterface_パラメーターは、メッセージストアの適切なインターフェイスの識別子に設定することもできます (たとえば、IID_IUnknown または IID_IMAPIProp)。 
    
 _lpcbSpoolSecurity_
  
> 読み上げストアプロバイダーが_lppbSpoolSecurity_パラメーターの検証データのサイズ (バイト単位) を返す変数へのポインター。 
    
 _lppbSpoolSecurity_
  
> 読み上げ返された検証データへのポインターへのポインター。 この検証データは、 [IMSProvider:: SpoolerLogon](imsprovider-spoolerlogon.md)メソッドで、メッセージストアプロバイダーと同じストアに MAPI スプーラーを記録できるようにするために用意されています。 
    
 _lppMAPIError_
  
> 読み上げエラーのバージョン、コンポーネント、およびコンテキスト情報を含む返された[MAPIERROR](mapierror.md)構造体へのポインターへのポインター。 返す**MAPIERROR**構造体がない場合は、 _lppMAPIError_パラメーターを**null**に設定できます。 
    
 _lppmslogon_
  
> 読み上げMAPI がログオンするためのメッセージストアログオンオブジェクトへのポインターへのポインター。
    
 _lppmdb_
  
> 読み上げログオンする MAPI スプーラーおよびクライアントアプリケーションのメッセージストアオブジェクトへのポインターへのポインター。
    
## <a name="return-value"></a>戻り値

S_OK 
  
> �ʘb���������A�\�������l�܂��͒l���Ԃ���܂��B
    
MAPI_E_FAILONEPROVIDER 
  
> このプロバイダーはログオンできませんが、このエラーによってサービスが無効になることはありません。 
    
MAPI_E_LOGON_FAILED 
  
> ログオンセッションを確立できませんでした。
    
MAPI_E_UNCONFIGURED 
  
> このプロファイルには、ログオンが完了するのに十分な情報が含まれていません。 この値が返されると、MAPI はメッセージストアプロバイダーのメッセージサービスエントリポイント関数を呼び出します。
    
MAPI_E_USER_CANCEL 
  
> ユーザーが操作をキャンセルしました。通常は、ダイアログボックスの **[キャンセル**] ボタンをクリックします。 
    
MAPI_E_UNKNOWN_CPID 
  
> サーバーは、クライアントのコードページをサポートするように構成されていません。
    
MAPI_E_UNKNOWN_LCID 
  
> サーバーは、クライアントのロケール情報をサポートするように構成されていません。
    
MAPI_W_ERRORS_RETURNED 
  
> 呼び出しは成功しましたが、メッセージストアプロバイダーにエラー情報があります。 この警告が返された場合、呼び出しは正常に処理されます。 この警告をテストするには、 **HR_FAILED**マクロを使用します。 詳細については、「[エラー処理にマクロを使用する](using-macros-for-error-handling.md)」を参照してください。 プロバイダーからエラー情報を取得するには、 [imapisession:: GetLastError](imapisession-getlasterror.md)メソッドを呼び出します。 
    
## <a name="remarks"></a>解説

MAPI は**IMSProvider:: Logon**メソッドを呼び出して、メッセージストアへのアクセスを取得するために必要な処理の大部分を行います。 メッセージストアプロバイダーは、特定のストアにアクセスするために必要なユーザー資格情報を検証し、MAPI スプーラーおよびクライアントアプリケーションがログオンできる_lppmdb_パラメーターでメッセージストアオブジェクトを返します。 
  
クライアントと mapi スプーラーが使用するために返されるメッセージストアオブジェクトに加えて、プロバイダーは、開いているストアを制御するために mapi が使用するメッセージストアログオンオブジェクトも返します。 メッセージストアのログオンオブジェクトとメッセージストアオブジェクトは、それぞれが他方に影響を与えることができるように、メッセージストアプロバイダーの内部に密接にリンクされている必要があります。 store オブジェクトと logon オブジェクトの使用は同一である必要があります。これらのオブジェクトは、2つのインターフェイスを公開する1つのオブジェクトとして機能するように、ログオンオブジェクトと store オブジェクトの間に1対1で対応する必要があります。 2つのオブジェクトは一緒に作成して、一緒に解放する必要があります。 
  
mapi によって作成され、 _lpMAPISup_パラメーターでプロバイダーに渡される mapi サポートオブジェクトは、プロバイダーが必要とする mapi の関数へのアクセスを提供します。 これらの機能には、プロファイル情報の保存と取得、アドレス帳へのアクセスなどが含まれます。 _lpMAPISup_ポインターは、開いているストアごとに異なる場合があります。 ログイン後にメッセージストアの呼び出しを処理する際に、ストアプロバイダーはそのストアに固有の_lpMAPISup_変数を使用する必要があります。 メッセージストアを開き、メッセージストアのログオンオブジェクトの作成に成功したすべての**ログオン**呼び出しでは、プロバイダーはストアのログオンオブジェクトに MAPI サポートオブジェクトへのポインターを保存し、次の参照を追加するために[IUnknown:: AddRef](https://msdn.microsoft.com/library/ms691379%28v=VS.85%29.aspx)メソッドを呼び出す必要があります。サポートオブジェクト。 
  
プロバイダーが**ログオン**呼び出し中にダイアログボックスを表示する場合は、 _uluiparam_パラメーターを使用する必要があります。 ただし、 _ulflags_に MDB_NO_DIALOG フラグが含まれている場合、ダイアログボックスは表示されません。 ユーザーインターフェイスを呼び出す必要があり、 _ulflags_では許可されていない場合、またはその他の理由でユーザーインターフェイスを表示できない場合は、プロバイダーは MAPI_E_LOGON_FAILED を返す必要があります。 **ログオン時**にダイアログボックスが表示され、ユーザーがログオンをキャンセルした場合、通常、ダイアログボックスの **[キャンセル**] ボタンをクリックすると、プロバイダーは MAPI_E_USER_CANCEL を返します。 
  
_lな tryid_パラメーターは、このメッセージストアが以前に作成した、ラップされていないストアエントリ識別子を指すことも、 **null**にすることもできます。 _lな tryid_がラップされていないエントリ識別子を指している場合、そのエントリ識別子は次のいずれかの場所から取得できます。 
  
- これは、ストアプロバイダーが以前にラップしてプロファイルセクションに**PR_ENTRYID** ([PidTagEntryId](pidtagentryid-canonical-property.md)) プロパティとして書き込んだエントリ識別子にすることができます。
    
- これは、プロバイダーが以前にラップし、呼び出し元クライアントに**PR_STORE_ENTRYID** ([PidTagStoreEntryId](pidtagstoreentryid-canonical-property.md)) プロパティとして返されたエントリ識別子にすることができます。 
    
- これは、プロバイダーが以前にラップし、呼び出し元クライアントにメッセージストアオブジェクトの**PR_ENTRYID**プロパティとして返されたエントリ識別子にすることができます。 
    
いずれの場合も、エントリ識別子が現在使用されているコンピューターとは別のコンピューターで作成されている可能性があります。
  
_lな tryid_が**null**ではない場合、メッセージストアを識別して検索するために必要なすべての情報が含まれている必要があります。 この情報には、ネットワークボリューム名、電話番号、ユーザーアカウント名などを含めることができます。 エントリ識別子のデータを使用してストアへの接続を確立できない場合、ストアプロバイダーは、開くダイアログボックスを表示して、ユーザーが開くストアを選択できるようにする必要があります。 サーバーの名前が変更された場合、アカウント名が変更された場合、またはネットワークの一部が使用できない場合などに、ダイアログボックスが必要になることがあります。
  
_lな tryid_が**null**の場合は、使用するメッセージストアがまだ選択されていません。 その他の方法でストアを指定した場合、プロバイダーはダイアログボックスを表示せずにストアにアクセスできます。 たとえば、プロバイダーは、初期化ファイルを確認したり、構成時にそのメッセージサービスのプロファイルセクションに配置された追加のプロパティを探したりすることができます。
  
必要なすべての情報がプロファイルに含まれていないことがプロバイダーによって検出された場合は、MAPI_E_UNCONFIGURED を返します。 その後、MAPI は、プロバイダーのメッセージサービスのエントリポイント関数を呼び出して、ユーザーがストアを選択したり、必要に応じてアカウント名とパスワードを入力したりできるようにします。 MAPI は新しいストアに対して新しいプロファイルセクションを自動的に作成します。この新しいプロファイルセクションは、追加方法によって、一時的または永続的なものにすることができます。 ストアプロバイダーが**imapisupport:: modifyprofile**メソッドを呼び出すと、新しいプロファイルセクションは永続的になり、ストアは[imapisupport:: getmsgstorestable](imapisession-getmsgstorestable.md)メソッドによって返されるメッセージストアの一覧に追加されます。 
  
_lpinterface_パラメーターは、新しく開かれた store オブジェクトに必要なインターフェイスの IID を指定します。 _lpinterface_で**null**を渡すことは、MAPI メッセージストアインターフェイス**IMsgStore**が必要であることを指定します。 メッセージストアオブジェクト IID_IMsgStore を渡すと、 **IMsgStore**が必須であることも指定されます。 IID_IUnknown が_lpinterface_で渡された場合、プロバイダーは、プロバイダーにとって最適な任意[](https://msdn.microsoft.com/library/ms680509%28v=VS.85%29.aspx)のインターフェイスを使用してストアを開く必要があります (通常は**IMsgStore**)。 IID_IUnknown が渡されると、呼び出し側の実装は、ストアのオープン操作が成功した後に、 [IUnknown:: QueryInterface](https://msdn.microsoft.com/library/ms682521%28v=VS.85%29.aspx)メソッドを使用してインターフェイスを選択します。 
  
**IMSProvider:: ログオン**呼び出しでは、ストアへのパスやストアにアクセスするための資格情報などの十分な情報が返されます。これにより、MAPI スプーラーは、ダイアログボックスを表示せずに、ストアプロバイダーが実行するのと同じストアにログオンすることができます。 _lpcbSpoolSecurity_パラメーターと_lppbSpoolSecurity_パラメーターは、この情報を返すために使用されます。 プロバイダーは、 [msproviderinit](msproviderinit.md)関数の_lpfAllocateBuffer_パラメーターでバッファーへのポインターを渡すことにより、このデータのメモリを割り当てます。プロバイダーは、このバッファーのサイズを_lpcbSpoolSecurity_に配置します。 
  
MAPI は、必要に応じてこのバッファーを解放します。 ストアへの MAPI スプーラーのログオンを、プロファイルセクション単独の情報から実行できる場合、プロバイダーは_lppbSpoolSecurity_で null を返すことができ、 _lpcbSpoolSecurity_では情報のサイズが0になります。 MAPI スプーラーログオンは、ストアログオンとは別のプロセスの一部として実行されます。渡された情報を格納しているバッファーはプロセス間でコピーされるため、ストアプロバイダープロセスの MAPI スプーラープロセスと同じ場所にメモリ内に存在しない可能性があります。 そのため、プロバイダーはこのバッファーにアドレスを入れてはなりません。 MAPI スプーラーログオンの詳細については、 [IMSProvider:: SpoolerLogon](imsprovider-spoolerlogon.md)メソッドを参照してください。 
  
ほとんどのストアプロバイダーでは、ユーザーの資格情報とオプションを保存および取得するために_lpMAPISup_パラメーターで渡される support オブジェクトの[imapisession:: openprofilesection](imapisession-openprofilesection.md)メソッドを使用します。 **** [openprofile] セクションでは、ストアプロバイダーが追加の任意の情報をプロファイルセクションに保存して、特定のリソースに関連付けることができます。 たとえば、ストアプロバイダーは、リソースに関連付けられたユーザーアカウント名とパスワード、およびそのリソースにアクセスするために必要なパスまたはその他の情報を保存できます。 
  
プロパティ識別子 0x6600 ~ 0x6600 を持つプロパティは、独自のプロファイルセクションにプライベートデータを格納するために独自に使用できる、セキュリティで保護されたプロパティとして提供されます。 プロファイルセクションオブジェクトでのプロパティの使用の詳細については、 [IProfSect: imapiprop](iprofsectimapiprop.md)メソッドを参照してください。 
  
識別子 0x6600 ~ 0x6600 を持つプロパティのプライベートデータに加えて、ストアプロバイダーは、そのプロファイルセクションに**PR_DISPLAY_NAME** ([PidTagDisplayName](pidtagdisplayname-canonical-property.md)) プロパティに関する情報を提供する必要があります。 **PR_DISPLAY_NAME**には、プロバイダー自体の表示名 ("Microsoft Personal Information Store" など) がユーザーに表示されるので、ユーザーがアクセス権を持っている可能性がある場合にこのメッセージストアを識別できるようにする必要があります。宛先。 **PR_DISPLAY_NAME**には、通常、サーバー名、ユーザーアカウント名、またはパスが含まれています。 
  
一部のプロファイルセクションのプロパティは、メッセージストアテーブルに表示されます。他のユーザーは、セットアップ時、インストール時、MAPI サブシステムの構成中に表示されます。 通常、プロバイダーは、保存された資格情報や個人情報が含まれていない新しいプロファイルセクション、およびプロパティ情報が変更されたことを検出したときに、これらの表示プロパティに関する情報を提供します。 プロファイルセクションの詳細については、「 [imapisupport:: openプロファイル](imapisupport-openprofilesection.md)」を参照してください。
  
ユーザーのログオンが正常に完了した後、MAPI に戻る前に、ストアプロバイダーはリソースの状態行のプロパティの配列を作成し、 [imapisupport:: modifystatusrow](imapisupport-modifystatusrow.md)メソッドを呼び出します。 
  
 現在の MAPI セッションで既に開いているメッセージストアを開く**ログオン**呼び出しは、前に説明した処理のほとんどをスキップします。 これらの呼び出しでは、ステータス行の作成、メッセージストアのログオンオブジェクトの取得、mapi サポートオブジェクトの**AddRef**の呼び出し、mapi スプーラーログオンのためのデータの取得は行われません。 これらの呼び出しは S_OK を返し、要求されたインターフェイスを持つメッセージストアオブジェクトを返します。 
  
このような呼び出しを検出するには、プロバイダーが、このプロバイダーオブジェクトに対して既に開いているストアのメッセージストアプロバイダーオブジェクトのリストを保持する必要があります。 **ログイン**呼び出しを処理するときに、プロバイダーは、開いているストアの一覧をスキャンし、ログオン先ストアが既に開いているかどうかを判断する必要があります。 その場合は、ユーザーの資格情報をチェックする必要がなく、可能であればダイアログボックスの表示を回避する必要があります。 ダイアログボックスを表示する必要がある場合、プロバイダーは返された情報を確認して、ストアが2回目に開かれたかどうかを確認する必要があります。 また、プロバイダーは、**ログオン**呼び出し処理の開始時に_lな tryid_を使用して、重複している開口をチェックする必要があります。 
  
開いているストアにアクセスする**ログオン**呼び出しの標準処理は次のとおりです。 
  
1. 要求された新しいインターフェイスが既存のストアのインターフェイスと同じである場合、ストアプロバイダーは既存のストアオブジェクトに対して**AddRef**を呼び出します。 それ以外の場合は、 **QueryInterface**を呼び出して新しいインターフェイスを取得します。 ストアが新しいインターフェイスをサポートしていない場合、プロバイダーはエラー値 MAPI_E_INTERFACE_NOT_SUPPORTED を返します。 
    
2. プロバイダーは、 _lppmdb_の既存の store オブジェクトの必要なインターフェイスへのポインターを返します。
    
3. プロバイダーは、 _lppmslogon_で**null**を返します。
    
4. プロバイダーは、呼び出しで渡された support オブジェクトのプロファイルを開かないようにする必要があります。 また、プロバイダーの一意の識別子を登録したり、ステータス行を登録したり、MAPI スプーラーログオンデータを返したりすることはできません。
    
5. プロバイダーは、オブジェクトへのポインターを必要としないため、サポートオブジェクトに対して**AddRef**を呼び出すことはできません。 
    
可能であれば、プロバイダーは**ログオン**呼び出しに対して適切なエラーと警告文字列を返す必要があります。これにより、ユーザーが動作しなかった理由を判断する際に、ユーザーの負荷が大幅に軽減されます。 これらの文字列を返すには、プロバイダーは**MAPIERROR**構造体のメンバーを設定します。 MAPI は、プロバイダーによって返された場合、 **MAPIERROR**構造を検索、使用、および解放します。 
  
この**MAPIERROR**構造体のメモリは、 **msproviderinit**呼び出しの_lpfAllocateBuffer_で渡されるバッファーを使用して割り当てる必要があります。 MAPI_UNICODE が**Logon** _ulflags_に設定されている場合、返される構造体に含まれるエラー文字列は、Unicode 形式である必要があります。それ以外の場合は、ANSI 文字セットである必要があります。 
  
**ログオン**から返されるエラー値のほとんどに対して、MAPI は失敗したプロバイダーが属しているメッセージサービスを無効にします。 mapi は、mapi セッションが終了するまで、これらのサービスに属しているプロバイダーを呼び出すことはありません。 これに対して、**ログオン**時に MAPI_E_FAILONEPROVIDER エラー値が返されても、MAPI はプロバイダーが属しているメッセージサービスを無効にしません。 セッションが終了するまでサービス全体を無効にすることを保証しないエラーが発生した場合、**ログオン**は MAPI_E_FAILONEPROVIDER を返します。 たとえば、プロバイダーがユーザーインターフェイスの表示を許可せず、必要なパスワードを使用できない場合に、このエラーが返されることがあります。 
  
プロバイダーがログオンから MAPI_E_UNCONFIGURED を返した場合、MAPI はプロバイダーのメッセージサービスのエントリ関数を呼び出して、ログオンを再試行します。 MAPI は、MSG_SERVICE_CONFIGURE が自身を構成する機会を提供するために、コンテキストとしてを渡します。 クライアントがログオン時にユーザーインターフェイスを許可することを選択した場合、サービスはその構成プロパティシートを表示して、ユーザーが構成情報を入力できるようにすることができます。
  
## <a name="see-also"></a>関連項目



[IMAPISession::GetMsgStoresTable](imapisession-getmsgstorestable.md)
  
[IMAPISession::OpenMsgStore](imapisession-openmsgstore.md)
  
[IMAPISession::OpenProfileSection](imapisession-openprofilesection.md)
  
[IMAPISupport::ModifyProfile](imapisupport-modifyprofile.md)
  
[IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md)
  
[IMsgStore: IMAPIProp](imsgstoreimapiprop.md)
  
[IMSProvider::SpoolerLogon](imsprovider-spoolerlogon.md)
  
[IProfSect : IMAPIProp](iprofsectimapiprop.md)
  
[MAPIERROR](mapierror.md)
  
[MSProviderInit](msproviderinit.md)
  
[IMSProvider : IUnknown](imsprovideriunknown.md)

