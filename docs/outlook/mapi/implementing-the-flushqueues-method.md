---
title: FlushQueues メソッドの実装
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 8719f8aa-a537-4253-b67d-c4d38c40472b
description: '最終更新日: 2015 年 3 月 9 日'
ms.openlocfilehash: 1e5c78c71f7fddb04d3517aca0a34efa151ece08
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/28/2019
ms.locfileid: "33411779"
---
# <a name="implementing-the-flushqueues-method"></a><span data-ttu-id="b5109-103">FlushQueues メソッドの実装</span><span class="sxs-lookup"><span data-stu-id="b5109-103">Implementing the FlushQueues Method</span></span>

  
  
<span data-ttu-id="b5109-104">**適用対象**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="b5109-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="b5109-105">MAPI スプーラーは [、IXPLogon::FlushQueues](ixplogon-flushqueues.md) メソッドを使用して、保留中のメッセージをトランスポート プロバイダー間でダウンロードしてアップロードします。</span><span class="sxs-lookup"><span data-stu-id="b5109-105">The MAPI spooler uses the [IXPLogon::FlushQueues](ixplogon-flushqueues.md) method to download and upload any pending messages to and from a transport provider.</span></span> <span data-ttu-id="b5109-106">通常、MAPI スプーラーは、セッションにログオンしているすべてのトランスポート プロバイダーのキューをフラッシュします。最初のトランスポート プロバイダーは、ユーザーのプロファイルのトランスポート注文セクションで設定されています。</span><span class="sxs-lookup"><span data-stu-id="b5109-106">Typically, the MAPI spooler will flush the queues for all transport providers that are logged on to the session, starting with the first transport provider as set in the transport order section of the user's profile.</span></span> <span data-ttu-id="b5109-107">キューのフラッシュは、ほとんどの場合、ユーザーが直接要求した結果なので、キューのフラッシュ中のメッセージの送受信は MAPI スプーラーと同期します。</span><span class="sxs-lookup"><span data-stu-id="b5109-107">Flushing queues is almost always the result of a direct request by the user, so the sending and receiving of messages while queues are flushing is synchronous to the MAPI spooler.</span></span> <span data-ttu-id="b5109-108">これらの呼び出しは同期的なので、トランスポート プロバイダーはそれらを可能な限り迅速に処理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-108">Because these calls are synchronous, the transport provider should process them as quickly as possible.</span></span> 
  
<span data-ttu-id="b5109-109">トランスポート プロバイダーは、適切なメッセージ処理を有効にし、MAPI スプーラーの **FlushQueues** 操作の一部として他のトランスポート プロバイダーが使用するモデムなどの外部リソースを有効にするには、次の手順に従って **FlushQueues** 呼び出しを処理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-109">Transport providers must handle the **FlushQueues** call as described in the following sequence of steps to enable proper message processing and to enable external resources such as modems to be used by other transport providers as part of the MAPI spooler's **FlushQueues** operation.</span></span> 
  
|<span data-ttu-id="b5109-110">**手順**</span><span class="sxs-lookup"><span data-stu-id="b5109-110">**Step**</span></span>|<span data-ttu-id="b5109-111">**コンポーネント**</span><span class="sxs-lookup"><span data-stu-id="b5109-111">**Component**</span></span>|<span data-ttu-id="b5109-112">**実装**</span><span class="sxs-lookup"><span data-stu-id="b5109-112">**Implementation**</span></span>|
|:-----|:-----|:-----|
|<span data-ttu-id="b5109-113">1.</span><span class="sxs-lookup"><span data-stu-id="b5109-113">1.</span></span>  <br/> |<span data-ttu-id="b5109-114">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="b5109-114">MAPI spooler</span></span>  <br/> |<span data-ttu-id="b5109-115">ユーザーのプロファイルのトランスポートの順序でリストされている最初のトランスポート プロバイダーの **FlushQueues** メソッドを呼び出し、要求されたフラグを  _ulFlags_ パラメーターに渡します。</span><span class="sxs-lookup"><span data-stu-id="b5109-115">Calls the **FlushQueues** method for the first transport provider listed in the transport order of the user's profile, passing the requested flags in the  _ulFlags_ parameter.</span></span> <span data-ttu-id="b5109-116">**FlushQueues は、** アップロードおよびダウンロード操作全体に対してすべてのフラグが設定された 1 回呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="b5109-116">**FlushQueues** is called once with all flags set for the entire upload and download operation.</span></span>  <br/> |
|<span data-ttu-id="b5109-117">2。</span><span class="sxs-lookup"><span data-stu-id="b5109-117">2.</span></span>  <br/> |<span data-ttu-id="b5109-118">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="b5109-118">Transport Provider</span></span>  <br/> |<span data-ttu-id="b5109-119">FlushQueues 呼び出しから戻る前に、多くの **ことを行う必要** があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-119">Needs to do a number of things before returning from the **FlushQueues** call.</span></span> <span data-ttu-id="b5109-120">以前に送信されたメッセージが延期されている場合は [、IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md) メソッドを呼び出し、NOTIFY_SENT_DEFERREDする必要があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-120">If previously submitted messages are being deferred, the [IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md) method should be called with the NOTIFY_SENT_DEFERRED flag set.</span></span> <span data-ttu-id="b5109-121">MAPI スプーラーは、トランスポート プロバイダーがメッセージの処理を終了する前に延期されたメッセージを取り消す可能性があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-121">Note that it is possible for the MAPI spooler to cancel a message that has been deferred before the transport provider has a chance to finish processing the message.</span></span>  <br/> <span data-ttu-id="b5109-122">トランスポート プロバイダーがモデムなどの外部リソースを使用する場合は、外部リソースへの接続を確立する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-122">If the transport provider uses an external resource such as a modem, the connection to the external resource should be established.</span></span>  <br/> <span data-ttu-id="b5109-123">トランスポート プロバイダー STATUS_OUTBOUND_FLUSH行の **PR_STATUS_CODE** ([PidTagStatusCode](pidtagstatuscode-canonical-property.md)) プロパティのビットは [、IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md) メソッドを使用して設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-123">The STATUS_OUTBOUND_FLUSH bit in the **PR_STATUS_CODE** ([PidTagStatusCode](pidtagstatuscode-canonical-property.md)) property of the transport provider's status row must be set using the [IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md) method.</span></span>  <br/> <span data-ttu-id="b5109-124">その後、トランスポート プロバイダーは **FlushQueues S_OKを返す必要** があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-124">The transport provider should then return S_OK for the **FlushQueues** call.</span></span>  <br/> |
|<span data-ttu-id="b5109-125">3。</span><span class="sxs-lookup"><span data-stu-id="b5109-125">3.</span></span>  <br/> |<span data-ttu-id="b5109-126">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="b5109-126">MAPI spooler</span></span>  <br/> |<span data-ttu-id="b5109-127">トランスポート プロバイダーの状態行で STATUS_OUTBOUND_FLUSH ビットを確認し、キュー内の最初のメッセージに対して [IXPLogon::SubmitMessage](ixplogon-submitmessage.md) を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b5109-127">Checks the transport provider's status row for the STATUS_OUTBOUND_FLUSH bit and calls [IXPLogon::SubmitMessage](ixplogon-submitmessage.md) for the first message in the queue.</span></span>  <br/> |
|<span data-ttu-id="b5109-128">4.</span><span class="sxs-lookup"><span data-stu-id="b5109-128">4.</span></span>  <br/> |<span data-ttu-id="b5109-129">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="b5109-129">Transport provider</span></span>  <br/> |<span data-ttu-id="b5109-130">メッセージを処理し **、SubmitMessage 呼び出しから返** します。</span><span class="sxs-lookup"><span data-stu-id="b5109-130">Handles the message and returns from the **SubmitMessage** call.</span></span>  <br/> |
|<span data-ttu-id="b5109-131">5.</span><span class="sxs-lookup"><span data-stu-id="b5109-131">5.</span></span>  <br/> |<span data-ttu-id="b5109-132">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="b5109-132">MAPI spooler</span></span>  <br/> |<span data-ttu-id="b5109-133">トランスポート プロバイダーが **SubmitMessage** から S_OKを返す場合、MAPI スプーラーは通常のメッセージ送信と同様に、メッセージの [IXPLogon::EndMessage](ixplogon-endmessage.md) を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b5109-133">If the transport provider returns S_OK from **SubmitMessage**, the MAPI spooler calls [IXPLogon::EndMessage](ixplogon-endmessage.md) for the message as it does with regular message sending.</span></span>  <br/> <span data-ttu-id="b5109-134">トランスポート プロバイダーが **SubmitMessage** から S_OK 以外の値を返す場合、MAPI スプーラーは EndMessage を呼び出す前、または **SubmitMessage** を再度呼び出す前に値を適切に処理します。 </span><span class="sxs-lookup"><span data-stu-id="b5109-134">If the transport provider returns a value other than S_OK from **SubmitMessage**, the MAPI spooler handles the value appropriately before calling **EndMessage**, or before calling **SubmitMessage** again.</span></span>  <br/> |
|<span data-ttu-id="b5109-135">6.</span><span class="sxs-lookup"><span data-stu-id="b5109-135">6.</span></span>  <br/> |<span data-ttu-id="b5109-136">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="b5109-136">Transport provider</span></span>  <br/> |<span data-ttu-id="b5109-137">_lpulFlags_ パラメーターのメッセージ処理状態を持つ **EndMessage** から返します。</span><span class="sxs-lookup"><span data-stu-id="b5109-137">Returns from **EndMessage** with its message processing status in the  _lpulFlags_ parameter.</span></span>  <br/> |
|<span data-ttu-id="b5109-138">7.</span><span class="sxs-lookup"><span data-stu-id="b5109-138">7.</span></span>  <br/> |<span data-ttu-id="b5109-139">MAPI スプーラーとトランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="b5109-139">MAPI spooler and transport provider</span></span>  <br/> |<span data-ttu-id="b5109-140">**SubmitMessage** -  **EndMessage** ループは、キュー内のすべてのメッセージがダウンロードされるまで続行されます。</span><span class="sxs-lookup"><span data-stu-id="b5109-140">The **SubmitMessage**- **EndMessage** loop continues until all messages in the queue have been downloaded.</span></span>  <br/> |
|<span data-ttu-id="b5109-141">8.</span><span class="sxs-lookup"><span data-stu-id="b5109-141">8.</span></span>  <br/> |<span data-ttu-id="b5109-142">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="b5109-142">MAPI spooler</span></span>  <br/> |<span data-ttu-id="b5109-143">トランスポート プロバイダーの [IXPLogon::TransportNotify](ixplogon-transportnotify.md) メソッドを呼び出して、メッセージのダウンロードが完了したとトランスポート プロバイダー NOTIFY_END_OUTBOUND_FLUSHします。</span><span class="sxs-lookup"><span data-stu-id="b5109-143">Notifies the transport provider that it has finished downloading messages by calling the transport provider's [IXPLogon::TransportNotify](ixplogon-transportnotify.md) method with the NOTIFY_END_OUTBOUND_FLUSH flag set.</span></span>  <br/> |
|<span data-ttu-id="b5109-144">9.</span><span class="sxs-lookup"><span data-stu-id="b5109-144">9.</span></span>  <br/> |<span data-ttu-id="b5109-145">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="b5109-145">Transport provider</span></span>  <br/> |<span data-ttu-id="b5109-146">送信メッセージの送信に使用される外部リソースを解放し、他のトランスポート プロバイダーがキューをフラッシュするために使用できます。</span><span class="sxs-lookup"><span data-stu-id="b5109-146">Frees any external resources used in sending outbound messages so they can be used by other transport providers to flush their queues.</span></span>  <br/> <span data-ttu-id="b5109-147">トランスポート プロバイダー STATUS_INBOUND_FLUSHの PR_STATUS_CODE **プロパティの** ビットは **、ModifyStatusRow を使用して設定する必要があります**。</span><span class="sxs-lookup"><span data-stu-id="b5109-147">The STATUS_INBOUND_FLUSH bit in the **PR_STATUS_CODE** property of the transport provider's status row must be set using **ModifyStatusRow**.</span></span>  <br/> |
|<span data-ttu-id="b5109-148">10.</span><span class="sxs-lookup"><span data-stu-id="b5109-148">10.</span></span>  <br/> |<span data-ttu-id="b5109-149">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="b5109-149">MAPI spooler</span></span>  <br/> |<span data-ttu-id="b5109-150">トランスポート プロバイダーの状態の行で、STATUS_INBOUND_FLUSHビットを確認し、設定されている場合は [IXPLogon::StartMessage](ixplogon-startmessage.md) を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b5109-150">Checks the transport provider's status row for the STATUS_INBOUND_FLUSH bit and calls [IXPLogon::StartMessage](ixplogon-startmessage.md) if it is set.</span></span>  <br/> |
|<span data-ttu-id="b5109-151">11.</span><span class="sxs-lookup"><span data-stu-id="b5109-151">11.</span></span>  <br/> |<span data-ttu-id="b5109-152">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="b5109-152">Transport provider</span></span>  <br/> |<span data-ttu-id="b5109-153">メッセージを処理し **、StartMessage から返します**。</span><span class="sxs-lookup"><span data-stu-id="b5109-153">Processes the message and returns from **StartMessage**.</span></span> <span data-ttu-id="b5109-154">トランスポート プロバイダーにアップロードする他のメッセージがある場合は、スプーラー **Notify** を呼び出し、NOTIFY_NEWMAILする必要があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-154">If the transport provider has other messages to upload, it should call **SpoolerNotify** with the NOTIFY_NEWMAIL flag set.</span></span>  <br/> <span data-ttu-id="b5109-155">トランスポート プロバイダーにアップロードするメッセージがない場合は **、STARTMessage** で渡された MAPI スプーラーがメッセージに対して [IMAPIProp::SaveChanges](imapiprop-savechanges.md)を呼び出して返す必要があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-155">If the transport provider has no messages to upload, it should call [IMAPIProp::SaveChanges](imapiprop-savechanges.md) on the message the MAPI spooler passed in **StartMessage** and return.</span></span>  <br/> |
|<span data-ttu-id="b5109-156">12.</span><span class="sxs-lookup"><span data-stu-id="b5109-156">12.</span></span>  <br/> |<span data-ttu-id="b5109-157">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="b5109-157">MAPI spooler</span></span>  <br/> |<span data-ttu-id="b5109-158">メッセージで **SaveChanges** が呼び **出されるまで、StartMessage** の呼び出しを続行します。</span><span class="sxs-lookup"><span data-stu-id="b5109-158">Continues calling **StartMessage** until **SaveChanges** is called on a message.</span></span> <span data-ttu-id="b5109-159">トランスポート プロバイダーのアップロードが完了すると、MAPI スプーラーは **TransportNotify** を呼び出し、NOTIFY_END_INBOUND_FLUSH設定します。</span><span class="sxs-lookup"><span data-stu-id="b5109-159">After the transport provider has finished uploading, the MAPI spooler calls **TransportNotify** with the NOTIFY_END_INBOUND_FLUSH flag set.</span></span>  <br/> |
|<span data-ttu-id="b5109-160">13.</span><span class="sxs-lookup"><span data-stu-id="b5109-160">13.</span></span>  <br/> |<span data-ttu-id="b5109-161">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="b5109-161">Transport provider</span></span>  <br/> |<span data-ttu-id="b5109-162">**ModifyStatusRow** を使用して、状態行の **PR_STATUS_CODE** プロパティの STATUS_INBOUND_FLUSH ビットをクリアし、すべての外部リソースを解放して、他のトランスポート プロバイダーが使用できます。</span><span class="sxs-lookup"><span data-stu-id="b5109-162">Clears the STATUS_INBOUND_FLUSH bit in the **PR_STATUS_CODE** property of its status row using **ModifyStatusRow** and releases all external resources so they are available for use by other transport providers.</span></span>  <br/> |
|<span data-ttu-id="b5109-163">14.</span><span class="sxs-lookup"><span data-stu-id="b5109-163">14.</span></span>  <br/> |<span data-ttu-id="b5109-164">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="b5109-164">MAPI spooler</span></span>  <br/> |<span data-ttu-id="b5109-165">ユーザー **のプロファイルのトランスポート** 順序で一覧表示されている次のトランスポート プロバイダーの FlushQueues を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b5109-165">Calls **FlushQueues** for the next transport provider listed in the transport order of the user's profile.</span></span>  <br/> |
   
<span data-ttu-id="b5109-166">クライアント アプリケーションがトランスポート プロバイダーの状態オブジェクトで [IMAPIStatus::FlushQueues](imapistatus-flushqueues.md) を呼び出す場合、トランスポート プロバイダーは **ModifyStatusRow** を使用して状態行に適切なビットを設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-166">If a client application calls [IMAPIStatus::FlushQueues](imapistatus-flushqueues.md) on a transport provider's status object, the transport provider should set the appropriate bit in its status row with **ModifyStatusRow**.</span></span> <span data-ttu-id="b5109-167">MAPI スプーラーは、MAPI スプーラーの便宜上、トランスポート プロバイダーの **IXPLogon::FlushQueues** メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b5109-167">The MAPI spooler then calls the transport provider's **IXPLogon::FlushQueues** method at the MAPI spooler's convenience.</span></span> <span data-ttu-id="b5109-168">クライアント アプリケーションの **IMAPIStatus::FlushQueues** 呼び出しの結果としてトランスポート プロバイダーの **IXPLogon::FlushQueues** メソッドが呼び出された場合、この操作はクライアント アプリケーションに対して非同期的に行われます。</span><span class="sxs-lookup"><span data-stu-id="b5109-168">When the transport provider's **IXPLogon::FlushQueues** method is called as a result of a client application's **IMAPIStatus::FlushQueues** call, the operation occurs asynchronously to the client application.</span></span> <span data-ttu-id="b5109-169">それ以外 **の場合、IXPLogon::FlushQueues は** MAPI スプーラーと同期して動作します。</span><span class="sxs-lookup"><span data-stu-id="b5109-169">Otherwise **IXPLogon::FlushQueues** works synchronously with the MAPI spooler.</span></span> 
  
<span data-ttu-id="b5109-170">パフォーマンス上の理由から、MAPI スプーラーは、トランスポート プロバイダーの状態行に STATUS_INBOUND_FLUSH フラグと STATUS_OUTBOUND_FLUSH フラグが設定されている場合にのみ、トランスポート プロバイダーの **FlushQueues** メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b5109-170">For performance reasons, the MAPI spooler will only call a transport provider's **FlushQueues** method if the STATUS_INBOUND_FLUSH and STATUS_OUTBOUND_FLUSH flags are set in the transport provider's status row.</span></span> <span data-ttu-id="b5109-171">したがって、トランスポート プロバイダーは、状態行の STATUS_OUTBOUND_FLUSH フラグとSTATUS_INBOUND_FLUSHをクリアすることで **、FlushQueues** 操作をいつでも停止できます。</span><span class="sxs-lookup"><span data-stu-id="b5109-171">Consequently, a transport provider can stop the **FlushQueues** operation at any time by clearing the STATUS_OUTBOUND_FLUSH and STATUS_INBOUND_FLUSH flags in its status row.</span></span> <span data-ttu-id="b5109-172">MAPI スプーラーがシャットダウン中で **、FlushQueues** 操作を終了する必要がある場合は、トランスポート **Notify** を呼び出し、NOTIFY_END_INBOUND_FLUSH フラグと NOTIFY_END_OUTBOUND_FLUSH フラグの両方を設定します。</span><span class="sxs-lookup"><span data-stu-id="b5109-172">If the MAPI spooler is shutting down and needs to end the **FlushQueues** operation, it calls **TransportNotify** with both the NOTIFY_END_INBOUND_FLUSH and NOTIFY_END_OUTBOUND_FLUSH flags set.</span></span> <span data-ttu-id="b5109-173">トランスポート プロバイダーは、すべての外部リソースを解放して返す必要があります。</span><span class="sxs-lookup"><span data-stu-id="b5109-173">The transport provider should release all external resources and return.</span></span> 
  

