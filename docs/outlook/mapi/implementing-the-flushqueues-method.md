---
title: FlushQueues メソッドの実装
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 8719f8aa-a537-4253-b67d-c4d38c40472b
description: '最終更新日時: 2015 年 3 月 9 日'
ms.openlocfilehash: baafd8b6437f4febaee9420b274c20ba3242cae6
ms.sourcegitcommit: 9d60cd82b5413446e5bc8ace2cd689f683fb41a7
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/11/2018
ms.locfileid: "19800963"
---
# <a name="implementing-the-flushqueues-method"></a><span data-ttu-id="4a567-103">FlushQueues メソッドの実装</span><span class="sxs-lookup"><span data-stu-id="4a567-103">Implementing the FlushQueues Method</span></span>

  
  
<span data-ttu-id="4a567-104">**適用対象**: Outlook</span><span class="sxs-lookup"><span data-stu-id="4a567-104">**Applies to**: Outlook</span></span> 
  
<span data-ttu-id="4a567-105">MAPI スプーラーでは、 [IXPLogon::FlushQueues](ixplogon-flushqueues.md)メソッドを使用して、ダウンロードして、トランスポート プロバイダーとの間に、保留中のメッセージをアップロードします。</span><span class="sxs-lookup"><span data-stu-id="4a567-105">The MAPI spooler uses the [IXPLogon::FlushQueues](ixplogon-flushqueues.md) method to download and upload any pending messages to and from a transport provider.</span></span> <span data-ttu-id="4a567-106">通常、MAPI スプーラーはすべてトランスポート プロバイダーは、セッションにログオンするユーザーのプロファイルのトランスポートの順序] セクションで設定されている最初のトランスポート プロバイダーを開始のキューをフラッシュします。</span><span class="sxs-lookup"><span data-stu-id="4a567-106">Typically, the MAPI spooler will flush the queues for all transport providers that are logged on to the session, starting with the first transport provider as set in the transport order section of the user's profile.</span></span> <span data-ttu-id="4a567-107">キューのフラッシュは、ほとんどの場合、ユーザーが直接要求の結果ですので送信側と受信メッセージ キューがフラッシュされるときに、MAPI スプーラーを同期。</span><span class="sxs-lookup"><span data-stu-id="4a567-107">Flushing queues is almost always the result of a direct request by the user, so the sending and receiving of messages while queues are flushing is synchronous to the MAPI spooler.</span></span> <span data-ttu-id="4a567-108">これらの呼び出しは同期であるため、トランスポート プロバイダーは、処理して、できるだけ早くします。</span><span class="sxs-lookup"><span data-stu-id="4a567-108">Because these calls are synchronous, the transport provider should process them as quickly as possible.</span></span> 
  
<span data-ttu-id="4a567-109">トランスポート プロバイダーは、適切なメッセージ処理を有効にして、MAPI スプーラーの一部として、他のトランスポート プロバイダーが使用するモデムなどの外部リソースを有効にするのには、次の一連の手順で説明したように**FlushQueues**呼び出しを処理する必要があります。**FlushQueues**操作です。</span><span class="sxs-lookup"><span data-stu-id="4a567-109">Transport providers must handle the **FlushQueues** call as described in the following sequence of steps to enable proper message processing and to enable external resources such as modems to be used by other transport providers as part of the MAPI spooler's **FlushQueues** operation.</span></span> 
  
|<span data-ttu-id="4a567-110">**手順**</span><span class="sxs-lookup"><span data-stu-id="4a567-110">**Step**</span></span>|<span data-ttu-id="4a567-111">**コンポーネント**</span><span class="sxs-lookup"><span data-stu-id="4a567-111">**Component**</span></span>|<span data-ttu-id="4a567-112">**実装**</span><span class="sxs-lookup"><span data-stu-id="4a567-112">**Implementation**</span></span>|
|:-----|:-----|:-----|
|<span data-ttu-id="4a567-113">1。</span><span class="sxs-lookup"><span data-stu-id="4a567-113">1.</span></span>  <br/> |<span data-ttu-id="4a567-114">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="4a567-114">MAPI spooler</span></span>  <br/> |<span data-ttu-id="4a567-115">_UlFlags_パラメーターで要求されたフラグを渡すこと、最初のトランスポート プロバイダーのユーザーのプロファイルでは、トランスポートの順番に記載されているため、 **FlushQueues**メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="4a567-115">Calls the **FlushQueues** method for the first transport provider listed in the transport order of the user's profile, passing the requested flags in the  _ulFlags_ parameter.</span></span> <span data-ttu-id="4a567-116">**FlushQueues**は、全体のアップロードとダウンロード操作のすべてのフラグが設定された 1 回だけ呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="4a567-116">**FlushQueues** is called once with all flags set for the entire upload and download operation.</span></span>  <br/> |
|<span data-ttu-id="4a567-117">2。</span><span class="sxs-lookup"><span data-stu-id="4a567-117">2.</span></span>  <br/> |<span data-ttu-id="4a567-118">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="4a567-118">Transport Provider</span></span>  <br/> |<span data-ttu-id="4a567-119">**FlushQueues**の呼び出しから戻る前にさまざまな処理を行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="4a567-119">Needs to do a number of things before returning from the **FlushQueues** call.</span></span> <span data-ttu-id="4a567-120">以前に提出メッセージが遅延している場合は、NOTIFY_SENT_DEFERRED フラグを設定して、 [IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md)メソッドを呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="4a567-120">If previously submitted messages are being deferred, the [IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md) method should be called with the NOTIFY_SENT_DEFERRED flag set.</span></span> <span data-ttu-id="4a567-121">MAPI スプーラーを無効にするトランスポート プロバイダーは、前に延期されたメッセージをキャンセルすることには、メッセージの処理を完了することがあります。</span><span class="sxs-lookup"><span data-stu-id="4a567-121">Note that it is possible for the MAPI spooler to cancel a message that has been deferred before the transport provider has a chance to finish processing the message.</span></span>  <br/> <span data-ttu-id="4a567-122">トランスポート プロバイダーは、モデムなどの外部リソースを使用する場合、外部リソースへの接続を確立する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4a567-122">If the transport provider uses an external resource such as a modem, the connection to the external resource should be established.</span></span>  <br/> <span data-ttu-id="4a567-123">[IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md)メソッドを使用して、STATUS_OUTBOUND_FLUSH、 **PR_STATUS_CODE** ([PidTagStatusCode](pidtagstatuscode-canonical-property.md))、トランスポート プロバイダーの状態の行のプロパティ内のビットを設定しなければなりません。</span><span class="sxs-lookup"><span data-stu-id="4a567-123">The STATUS_OUTBOUND_FLUSH bit in the **PR_STATUS_CODE** ([PidTagStatusCode](pidtagstatuscode-canonical-property.md)) property of the transport provider's status row must be set using the [IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md) method.</span></span>  <br/> <span data-ttu-id="4a567-124">トランスポート プロバイダーは、 **FlushQueues**呼び出しの S_OK を返す必要があります。</span><span class="sxs-lookup"><span data-stu-id="4a567-124">The transport provider should then return S_OK for the **FlushQueues** call.</span></span>  <br/> |
|<span data-ttu-id="4a567-125">3。</span><span class="sxs-lookup"><span data-stu-id="4a567-125">3.</span></span>  <br/> |<span data-ttu-id="4a567-126">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="4a567-126">MAPI spooler</span></span>  <br/> |<span data-ttu-id="4a567-127">STATUS_OUTBOUND_FLUSH ビットのトランスポート プロバイダーの状態の行をチェックし、キューの最初のメッセージの[IXPLogon::SubmitMessage](ixplogon-submitmessage.md)を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="4a567-127">Checks the transport provider's status row for the STATUS_OUTBOUND_FLUSH bit and calls [IXPLogon::SubmitMessage](ixplogon-submitmessage.md) for the first message in the queue.</span></span>  <br/> |
|<span data-ttu-id="4a567-128">4。</span><span class="sxs-lookup"><span data-stu-id="4a567-128">4.</span></span>  <br/> |<span data-ttu-id="4a567-129">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="4a567-129">Transport provider</span></span>  <br/> |<span data-ttu-id="4a567-130">メッセージを処理し、 **SubmitMessage**の呼び出しから返されます。</span><span class="sxs-lookup"><span data-stu-id="4a567-130">Handles the message and returns from the **SubmitMessage** call.</span></span>  <br/> |
|<span data-ttu-id="4a567-131">5。</span><span class="sxs-lookup"><span data-stu-id="4a567-131">5.</span></span>  <br/> |<span data-ttu-id="4a567-132">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="4a567-132">MAPI spooler</span></span>  <br/> |<span data-ttu-id="4a567-133">トランスポート プロバイダーでは、 **SubmitMessage**から S_OK が返された場合、MAPI スプーラーを無効の場合と通常のメッセージを送信するメッセージの[IXPLogon::EndMessage](ixplogon-endmessage.md)を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="4a567-133">If the transport provider returns S_OK from **SubmitMessage**, the MAPI spooler calls [IXPLogon::EndMessage](ixplogon-endmessage.md) for the message as it does with regular message sending.</span></span>  <br/> <span data-ttu-id="4a567-134">トランスポート プロバイダーでは、 **SubmitMessage**から S_OK 以外の値が返された場合、MAPI スプーラーは、 **EndMessage**を呼び出す前に、またはもう一度**SubmitMessage**を呼び出す前に適切に値を処理します。</span><span class="sxs-lookup"><span data-stu-id="4a567-134">If the transport provider returns a value other than S_OK from **SubmitMessage**, the MAPI spooler handles the value appropriately before calling **EndMessage**, or before calling **SubmitMessage** again.</span></span>  <br/> |
|<span data-ttu-id="4a567-135">6。</span><span class="sxs-lookup"><span data-stu-id="4a567-135">6.</span></span>  <br/> |<span data-ttu-id="4a567-136">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="4a567-136">Transport provider</span></span>  <br/> |<span data-ttu-id="4a567-137">**EndMessage**からそのメッセージの処理、 _lpulFlags_パラメーターのステータスを返します。</span><span class="sxs-lookup"><span data-stu-id="4a567-137">Returns from **EndMessage** with its message processing status in the  _lpulFlags_ parameter.</span></span>  <br/> |
|<span data-ttu-id="4a567-138">7。</span><span class="sxs-lookup"><span data-stu-id="4a567-138">7.</span></span>  <br/> |<span data-ttu-id="4a567-139">MAPI スプーラーとトランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="4a567-139">MAPI spooler and transport provider</span></span>  <br/> |<span data-ttu-id="4a567-140">**SubmitMessage**- **EndMessage**ループがキュー内のすべてのメッセージのダウンロードが完了するまで続行します。</span><span class="sxs-lookup"><span data-stu-id="4a567-140">The **SubmitMessage**- **EndMessage** loop continues until all messages in the queue have been downloaded.</span></span>  <br/> |
|<span data-ttu-id="4a567-141">8。</span><span class="sxs-lookup"><span data-stu-id="4a567-141">8.</span></span>  <br/> |<span data-ttu-id="4a567-142">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="4a567-142">MAPI spooler</span></span>  <br/> |<span data-ttu-id="4a567-143">トランスポート プロバイダーは、NOTIFY_END_OUTBOUND_FLUSH フラグを設定して、トランスポート プロバイダーの[IXPLogon::TransportNotify](ixplogon-transportnotify.md)メソッドを呼び出して、メッセージのダウンロードが完了したことを通知します。</span><span class="sxs-lookup"><span data-stu-id="4a567-143">Notifies the transport provider that it has finished downloading messages by calling the transport provider's [IXPLogon::TransportNotify](ixplogon-transportnotify.md) method with the NOTIFY_END_OUTBOUND_FLUSH flag set.</span></span>  <br/> |
|<span data-ttu-id="4a567-144">9。</span><span class="sxs-lookup"><span data-stu-id="4a567-144">9.</span></span>  <br/> |<span data-ttu-id="4a567-145">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="4a567-145">Transport provider</span></span>  <br/> |<span data-ttu-id="4a567-146">キューをフラッシュするその他のトランスポート プロバイダーによって使用できるように、送信メッセージを送信することで使用されている外部リソースを解放します。</span><span class="sxs-lookup"><span data-stu-id="4a567-146">Frees any external resources used in sending outbound messages so they can be used by other transport providers to flush their queues.</span></span>  <br/> <span data-ttu-id="4a567-147">**ModifyStatusRow**では、ビットのトランスポート プロバイダーは、[状態] 行の**PR_STATUS_CODE**プロパティに STATUS_INBOUND_FLUSH を設定しなければなりません。</span><span class="sxs-lookup"><span data-stu-id="4a567-147">The STATUS_INBOUND_FLUSH bit in the **PR_STATUS_CODE** property of the transport provider's status row must be set using **ModifyStatusRow**.</span></span>  <br/> |
|<span data-ttu-id="4a567-148">10。</span><span class="sxs-lookup"><span data-stu-id="4a567-148">10.</span></span>  <br/> |<span data-ttu-id="4a567-149">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="4a567-149">MAPI spooler</span></span>  <br/> |<span data-ttu-id="4a567-150">STATUS_INBOUND_FLUSH ビットのトランスポート プロバイダーの状態の行をチェックし、設定されている場合に[IXPLogon::StartMessage](ixplogon-startmessage.md)を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="4a567-150">Checks the transport provider's status row for the STATUS_INBOUND_FLUSH bit and calls [IXPLogon::StartMessage](ixplogon-startmessage.md) if it is set.</span></span>  <br/> |
|<span data-ttu-id="4a567-151">11。</span><span class="sxs-lookup"><span data-stu-id="4a567-151">11.</span></span>  <br/> |<span data-ttu-id="4a567-152">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="4a567-152">Transport provider</span></span>  <br/> |<span data-ttu-id="4a567-153">メッセージを処理し、 **StartMessage**から返されます。</span><span class="sxs-lookup"><span data-stu-id="4a567-153">Processes the message and returns from **StartMessage**.</span></span> <span data-ttu-id="4a567-154">トランスポート プロバイダーにアップロードするには、他のメッセージがある場合は、NOTIFY_NEWMAIL フラグを設定して**SpoolerNotify**を呼び出す必要があること。</span><span class="sxs-lookup"><span data-stu-id="4a567-154">If the transport provider has other messages to upload, it should call **SpoolerNotify** with the NOTIFY_NEWMAIL flag set.</span></span>  <br/> <span data-ttu-id="4a567-155">アップロード メッセージ トランスポート プロバイダーがない場合は、MAPI スプーラーが**StartMessage**に渡され、返すメッセージの[IMAPIProp::SaveChanges](imapiprop-savechanges.md)を呼び出す必要があること。</span><span class="sxs-lookup"><span data-stu-id="4a567-155">If the transport provider has no messages to upload, it should call [IMAPIProp::SaveChanges](imapiprop-savechanges.md) on the message the MAPI spooler passed in **StartMessage** and return.</span></span>  <br/> |
|<span data-ttu-id="4a567-156">12。</span><span class="sxs-lookup"><span data-stu-id="4a567-156">12.</span></span>  <br/> |<span data-ttu-id="4a567-157">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="4a567-157">MAPI spooler</span></span>  <br/> |<span data-ttu-id="4a567-158">メッセージに**SaveChanges**が呼び出されるまで、 **StartMessage**を呼び出すことが続行されます。</span><span class="sxs-lookup"><span data-stu-id="4a567-158">Continues calling **StartMessage** until **SaveChanges** is called on a message.</span></span> <span data-ttu-id="4a567-159">トランスポート プロバイダーは、アップロードが終了したら、MAPI スプーラーは、NOTIFY_END_INBOUND_FLUSH フラグを設定して**TransportNotify**を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="4a567-159">After the transport provider has finished uploading, the MAPI spooler calls **TransportNotify** with the NOTIFY_END_INBOUND_FLUSH flag set.</span></span>  <br/> |
|<span data-ttu-id="4a567-160">13 です。</span><span class="sxs-lookup"><span data-stu-id="4a567-160">13.</span></span>  <br/> |<span data-ttu-id="4a567-161">トランスポート プロバイダー</span><span class="sxs-lookup"><span data-stu-id="4a567-161">Transport provider</span></span>  <br/> |<span data-ttu-id="4a567-162">STATUS_INBOUND_FLUSH の他のトランスポート プロバイダーによって**ModifyStatusRow**と使用して、すべての外部リソースを利用できるようにリリースを使用して、[状態] 行の**PR_STATUS_CODE**プロパティでビットをクリアします。</span><span class="sxs-lookup"><span data-stu-id="4a567-162">Clears the STATUS_INBOUND_FLUSH bit in the **PR_STATUS_CODE** property of its status row using **ModifyStatusRow** and releases all external resources so they are available for use by other transport providers.</span></span>  <br/> |
|<span data-ttu-id="4a567-163">14。</span><span class="sxs-lookup"><span data-stu-id="4a567-163">14.</span></span>  <br/> |<span data-ttu-id="4a567-164">MAPI スプーラー</span><span class="sxs-lookup"><span data-stu-id="4a567-164">MAPI spooler</span></span>  <br/> |<span data-ttu-id="4a567-165">ユーザーのプロファイルのトランスポートの順番に記載されている次のトランスポート プロバイダーの**FlushQueues**が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="4a567-165">Calls **FlushQueues** for the next transport provider listed in the transport order of the user's profile.</span></span>  <br/> |
   
<span data-ttu-id="4a567-166">トランスポート プロバイダーの状態のオブジェクトをクライアント アプリケーションが[IMAPIStatus::FlushQueues](imapistatus-flushqueues.md)場合、トランスポート プロバイダーは、 **ModifyStatusRow**のステータス行の適切なビットを設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4a567-166">If a client application calls [IMAPIStatus::FlushQueues](imapistatus-flushqueues.md) on a transport provider's status object, the transport provider should set the appropriate bit in its status row with **ModifyStatusRow**.</span></span> <span data-ttu-id="4a567-167">MAPI スプーラー メソッドを呼び出して、トランスポート プロバイダーの**IXPLogon::FlushQueues** MAPI スプーラーでの利便性のために。</span><span class="sxs-lookup"><span data-stu-id="4a567-167">The MAPI spooler then calls the transport provider's **IXPLogon::FlushQueues** method at the MAPI spooler's convenience.</span></span> <span data-ttu-id="4a567-168">トランスポート プロバイダーの**IXPLogon::FlushQueues**メソッドが呼び出されたとき、クライアント アプリケーションの**IMAPIStatus::FlushQueues**の呼び出しの結果としてクライアント アプリケーションに非同期操作が発生しました。</span><span class="sxs-lookup"><span data-stu-id="4a567-168">When the transport provider's **IXPLogon::FlushQueues** method is called as a result of a client application's **IMAPIStatus::FlushQueues** call, the operation occurs asynchronously to the client application.</span></span> <span data-ttu-id="4a567-169">それ以外の場合**IXPLogon::FlushQueues**は、MAPI スプーラーでは同期的に動作します。</span><span class="sxs-lookup"><span data-stu-id="4a567-169">Otherwise **IXPLogon::FlushQueues** works synchronously with the MAPI spooler.</span></span> 
  
<span data-ttu-id="4a567-170">パフォーマンス上の理由から、MAPI スプーラーがのみメソッドを呼び出す、トランスポート プロバイダーの**FlushQueues**トランスポート プロバイダーの [状態] 行で、STATUS_INBOUND_FLUSH と STATUS_OUTBOUND_FLUSH のフラグが設定されている場合。</span><span class="sxs-lookup"><span data-stu-id="4a567-170">For performance reasons, the MAPI spooler will only call a transport provider's **FlushQueues** method if the STATUS_INBOUND_FLUSH and STATUS_OUTBOUND_FLUSH flags are set in the transport provider's status row.</span></span> <span data-ttu-id="4a567-171">その結果、トランスポート プロバイダーのステータス行に STATUS_OUTBOUND_FLUSH と STATUS_INBOUND_FLUSH のフラグをオフにしてはいつでも**FlushQueues**の操作を停止できます。</span><span class="sxs-lookup"><span data-stu-id="4a567-171">Consequently, a transport provider can stop the **FlushQueues** operation at any time by clearing the STATUS_OUTBOUND_FLUSH and STATUS_INBOUND_FLUSH flags in its status row.</span></span> <span data-ttu-id="4a567-172">MAPI スプーラーをシャット ダウンして、 **FlushQueues**の操作を終了する必要がある場合は、NOTIFY_END_INBOUND_FLUSH と NOTIFY_END_OUTBOUND_FLUSH の両方のフラグのセットを使用して**TransportNotify**を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="4a567-172">If the MAPI spooler is shutting down and needs to end the **FlushQueues** operation, it calls **TransportNotify** with both the NOTIFY_END_INBOUND_FLUSH and NOTIFY_END_OUTBOUND_FLUSH flags set.</span></span> <span data-ttu-id="4a567-173">トランスポート プロバイダーはすべての外部リソースを解放する必要があり、返します。</span><span class="sxs-lookup"><span data-stu-id="4a567-173">The transport provider should release all external resources and return.</span></span> 
  

