---
title: Excel でのマルチスレッド再計算
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
ms.topic: reference
keywords:
- thread-safe cells [excel 2007],multithreading in Excel,concurrent tasks [Excel 2007],thread-safe functions [Excel 2007],multithreaded recalculation [Excel 2007],MTR [Excel 2007],XLL functions [Excel 2007], registering as thread safe,recalculation [Excel 2007], multithreaded,memory contention [Excel 2007],registering XLL functions as thread safe [Excel 2007],unsafe functions [Excel 2007]
ms.assetid: c6c831f1-4be1-4dcc-a0fa-c26052ec53c9
description: '適用対象: Excel 2013 | Office 2013 | Visual Studio'
localization_priority: Priority
ms.openlocfilehash: f0b6f3d7310cac6d141fc74652a3333f70bda8e9
ms.sourcegitcommit: d6695c94415fa47952ee7961a69660abc0904434
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/17/2019
ms.locfileid: "28720710"
---
# <a name="multithreaded-recalculation-in-excel"></a>Excel でのマルチスレッド再計算

**適用対象**: Excel 2013 | Office 2013 | Visual Studio 
  
Microsoft Office Excel 2007 �́A���[�N�V�[�g�̃}���`�X���b�h�Čv�Z (MTR) �g�p���� Excel �̍ŏ��̃o�[�W�����ł����B�R���s���[�^�[�̃v���Z�b�T����v���Z�b�T�̃R�A���ɊW�Ȃ��A�Čv�Z���ɍő� 1024 �̓������s�X���b�h��g�p����悤�� Excel ��\���ł��܂��B 
  
> [!NOTE]
> それぞれのスレッドには関連するオペレーティング システムのオーバーヘッドがあるため、必要以上に多くのスレッドを使用するように Excel を構成してはいけません。 
  
コンピューターに複数のプロセッサまたはプロセッサのコアが搭載されている場合は、オペレーティング システムが、最適な方法でプロセッサにスレッドを割り当てます。
  
## <a name="excel-mtr-overview"></a>Excel の MTR の概要

Excel �́A�v�Z�`�F�[���̊e�����̂����A�ʁX�̃X���b�h�ŕ��s�I�ɍČv�Z�ł��镔������ʂ��悤�Ƃ��܂��B���̔��ɒP���ȃc���[ (x �� y �́Ay �� x �ɂ݈̂ˑ����Ă��邱�Ƃ�Ӗ�����) �́A���̗������Ă��܂��B
  
**図 1. 別々のスレッドでの同時並行計算**

![複数のスレッドでの同時並行計算](media/12b5a52b-6308-420c-b6cf-492bd1f195ce.gif "複数のスレッドでの同時並行計算")
  
A1 の計算が済むと、一方のスレッドでは A2、A3 の順に計算ができるようになり、同時に、もう一方のスレッドでは B1、C1 の順に計算ができるようになります (すべてのセルがスレッド セーフであると仮定しています)。 
  
> [!NOTE]
> [!����] �X���b�h �Z�[�t�ȃZ���Ƃ����p��́A�X���b�h �Z�[�t�Ȋ��݂̂�܂ރZ����Ӗ����܂��B�X���b�h �Z�[�t�ł��邩�ǂ����ɂẮA[Excel �ŃX���b�h �Z�[�t�ƌ��Ȃ������ (���Ȃ���Ȃ����)](#xl2007xllsdk_threadsafe)�ŏڂ���������܂��B 
  
�قƂ�ǂ̎��p�I�ȃu�b�N�ɂ́A���̗����͂邩�ɕ��G�Ȉˑ��W�c���[���܂܂�Ă��܂��B����ɁA�Z���̍Čv�Z�ɂ����鎞�Ԃ͌v�Z����������܂ŕs���ł���A���̈����ɂ���đ啝�ɈقȂ邱�Ƃ�����܂��B�ŗǂ̌��ʂ𓾂邽�߂ɁAExcel �́A����ȏ�̍œK�����ł��Ȃ��Ȃ�܂ŁA�v�Z�̂��тɌv�Z�����̉��P����݂܂��B
  
Excel は、次の項目の実行に単一のメイン スレッドを使用します。
  
- 組み込みコマンド
    
- XLL コマンド
    
- アドイン マネージャー インターフェイス関数 (**xlAutoOpen** 関数など) 
    
- Microsoft Visual Basic for Applications (VBA) のユーザー定義コマンド (通常はマクロと呼ばれます)
    
- VBA のユーザー定義関数
    
- 組み込みのスレッド セーフではないワークシート関数 (次のセクションに一覧を示します)
    
- XLM マクロ シートのユーザー定義コマンドとユーザー定義関数
    
- COM アドインのコマンドと関数
    
- 条件付きフォーマット式内の関数と演算子
    
- ワークシートの式で使用された定義済みの名前定義内の関数と演算子
    
- 数式編集ボックス内の式の強制的な評価 (**F9** キーを使用) 
    
���ׂẴ��[�N�V�[�g�̐����́A�����X���b�h �Z�[�t���ǂ����ɊW�Ȃ��A���C�� �X���b�h�ŕ]������܂��B�������A�����̃X���b�h��g�p����悤�� Excel ��\�����Ă���ꍇ������܂��B���[�U�[�������̃X���b�h��g�p����悤�Ɏw�肷��ƁA�X���b�h �Z�[�t�̃Z���ɂ͒ǉ��̃X���b�h���g�p����܂��B���ו��U�̊ϓ_����̍������ɓK���ꍇ�́A���C�� �X���b�h��X���b�h �Z�[�t�ȃZ���Ɏg�p����܂��B
  
ここでもう一度強調すべきこととして、Excel は一度に複数のコマンドを実行しません。そのため、スレッド ローカル メモリとクリティカル セクションの使用など、スレッド セーフな関数を記述するときと同様の注意を払う必要はありません。
  
## <a name="what-is-and-is-not-considered-thread-safe-by-excel"></a>Excel でスレッド セーフと見なされるもの (見なされないもの)
<a name="xl2007xllsdk_threadsafe"> </a>

Excel では、次のものだけがスレッド セーフと見なされます。
  
- Excel の単項演算子と二項演算子のすべて
    
- Excel 2007 �ȍ~�̑g�ݍ��݃��[�N�V�[�g���̂قƂ�ǂ��ׂ� (��O�̈ꗗ��Q��)
    
- スレッド セーフとして明示的に登録されている XLL アドイン関数
    
次の組み込みワークシート関数は、スレッド セーフではありません。
  
- **PHONETIC**
    
- **CELL** ("����" �܂��� "�A�h���X" �̂ǂ��炩�̈������g�p���ꂽ�ꍇ) 
    
- **INDIRECT**
    
- **GETPIVOTDATA**
    
- **CUBEMEMBER**
    
- **CUBEVALUE**
    
- **CUBEMEMBERPROPERTY**
    
- **CUBESET**
    
- **CUBERANKEDMEMBER**
    
- **CUBEKPIMEMBER**
    
- **CUBESETCOUNT**
    
- **ADDRESS** (5 番目のパラメーター "sheet_name" が指定されている場合) 
    
- ピボットテーブルを参照するデータベース関数 (**DSUM**、**DAVERAGE** など)
    
- **ERROR.TYPE**
    
- **HYPERLINK**
    
明確にするために、スレッド セーフと見なされないものを挙げます。
  
- VBA のユーザー定義関数
    
- COM アドインのユーザー定義関数
    
- XLM マクロ シートのユーザー定義関数
    
- 明示的にスレッド セーフとして登録されていない XLL アドイン関数
    
次の操作と関数はスレッド セーフとは見なされません。また、スレッド セーフとして登録した XLL 関数から呼び出されると失敗します。
  
- XLM 情報関数 (**xlfGetCell** (**GET.CELL**) など) の呼び出し。
    
- XLL 内部名の定義または削除のための **xlfSetName** (**SET.NAME**) の呼び出し。
    
- スレッド セーフではないユーザー定義関数の **xlUDF** を使用した呼び出し。
    
- スレッド セーフではない関数を含む式、またはスレッド セーフではない関数を含む定義によって定義された名前を含む式に対する [xlfEvaluate](xlfevaluate.md) 関数の呼び出し。 
    
- ブレーク条件をクリアする [xlAbort](xlabort.md) 関数の呼び出し。 
    
- 計算されていないセルの参照の値を取得する [xlCoerce](xlcoerce.md) 関数の呼び出し。 
    
> [!NOTE]
> [!����] XLL ���[�N�V�[�g�� ( **xlcSave** �Ȃ�) �ł́AC API �R�}���h�̌Ăяo����������Ă��܂���B���̊����X���b�h �Z�[�t�Ƃ��ēo�^����Ă��邩�ǂ����͊W����܂���B 
  
�X���b�h �Z�[�t�Ƃ��Đ錾���ꂽ XLL ���� XLM ������Ăяo���Ȃ����Ƃ�A�v�Z����Ă��Ȃ��Z����Q�Ƃł��Ȃ����Ƃ���AExcel �� �}�N�� �V�[�g�Ɠ����Ƃ��ēo�^���� XLL ����X���b�h �Z�[�t�Ƃ��Ă�o�^���邱�Ƃ�����܂���B���̂��߁A **xlCoerce** ��g�p���Čv�Z����Ă��Ȃ��Z���̎Q�Ƃ̒l��擾���悤�Ƃ���ƁA **xlretUncalced** �G���[�Ŏ��s���܂��BXLM �����̌Ăяo���́A **xlretFailed** �G���[�Ŏ��s���܂��B���̑��̑O�q�����|�C���g�́AExcel C API �ɓ������ꂽ�G���[ �R�[�h **xlretNotThreadSafe** �Ŏ��s���܂��B 
  
C API 専用のコールバック関数は、すべてスレッド セーフです。
  
- **xlCoerce** (�������A�v�Z����Ă��Ȃ��Z���̎Q�Ƃ̋����^�ϊ��͎��s���܂�) 
    
- **xlFree**
    
- **xlStack**
    
- **xlSheetId**
    
- **xlSheetNm**
    
- **xlAbort** (�u���[�N�����N���A���邽�߂Ɏg�p����ꍇ������܂�) 
    
- **xlGetInst**
    
- **xlGetHwnd**
    
- **xlGetBinaryName**
    
- **xlDefineBinaryName**
    
�B��̗�O�� **xlSet** ���ł��B�����̏ꍇ�A���̊��̓R�}���h�Ɠ����ł��邽�߁A�ǂ̂悤�ȃ��[�N�V�[�g�������Ăяo���ł��܂���B 
  
XLL ���[�N�V�[�g���́A�X���b�h �Z�[�t�Ƃ��� Excel �ɓo�^�ł��܂��B����ɂ��A���̊������S�ɕ����̃X���b�h�œ����ɌĂяo���邱�Ƃ� Excel �ɒʒm���܂��B�������A���ꂪ�����ł��邱�Ƃ͎����Ŋm�F����K�v������܂��B�X���b�h �Z�[�t�Ƃ��ēo�^�������̓��삪�X���b�h �Z�[�t�łȂ��ƁAExcel ���s����ɂȂ邱�Ƃ�����܂��B
  
## <a name="registering-xll-functions-as-thread-safe"></a>XLL 関数をスレッド セーフとして登録する
<a name="xl2007xllsdk_threadsafe"> </a>

スレッド セーフな関数を記述するときに、開発者が従う必要のあるルールは次のとおりです。
  
- スレッド セーフではない可能性のある別の DLL 内のリソースを呼び出さない。
    
- C API または COM を通じてスレッド セーフでない呼び出しを行わない。
    
- クリティカル セクションを使用して、複数のスレッドで同時に使用される可能性のあるリソースを保護する。
    
- スレッド固有のストレージにはスレッド ローカル メモリを使用して、関数内の静的変数はスレッド ローカル変数に置き換える。
    
Excel には、もう 1 つの制限が課せられます。スレッド セーフな関数をマクロ シートと同等なものとして登録することはできません。そのため、XLM 情報関数を呼び出すことや、再計算されていないセルの値を取得することはできません。
  
## <a name="memory-contention"></a>メモリの競合
<a name="xl2007xllsdk_threadsafe"> </a>

マルチスレッド システムは、2 つの基本的な問題に対処する必要があります。
  
- 複数のスレッドが読み書きするメモリの保護方法。
    
- 実行中のスレッドに関連付けられてプライベートになるメモリの作成方法とアクセス方法。
    
Windows �I�y���[�e�B���O �V�X�e���� Windows �\�t�g�E�F�A�J���L�b�g (SDK) �ɂ́A����痼���ɂ��ꂼ��Ή�����c�[���ł���N���e�B�J�� �Z�b�V�����ƃX���b�h ���[�J�� �X�g���[�W (TLS) API ��g�p�ł��܂��B�ڍׂɂ��ẮA�u[Excel �̃������Ǘ�](memory-management-in-excel.md)�v��Q�Ƃ��Ă��������B
  
�ŏ��̖��́A���Ƃ��A2 �̃��[�N�V�[�g�� (�܂��͓������� 2 �̓������s�C���X�^���X) �� 1 �� DLL �v���W�F�N�g��̃O���[�o���ϐ��ɃA�N�Z�X���� (�܂��͕ύX�������) �K�v������ꍇ�ɔ������܂��B���̂悤�ȃO���[�o���ϐ��́A�O���[�o���ɃA�N�Z�X�ł���N���X �I�u�W�F�N�g�̃C���X�^���X��ɉB����Ă��邱�Ƃ�����_�ɒ��ӂ��K�v�ł��B
  
2 �ڂ̖��́A���Ƃ��A���[�N�V�[�g�������{�̂̃R�[�h��ŐÓI�ȕϐ��܂��̓I�u�W�F�N�g�錾���Ă���ꍇ�ɔ������܂��BC/C++ �R���p�C���́A���ׂẴX���b�h���g�p���� 1 �̃R�s�[�݂̂�쐬���܂��B���̂��߁A���̈���̃C���X�^���X���l��ύX���Ă���Ƃ��ɁA�ʂ̃X���b�h�̂������̃C���X�^���X�͒l���ȑO�ɐݒ肳�ꂽ��e���Ƒz�肵�Ă���\��������Ƃ������Ƃł��B
  
## <a name="example-applications-of-mtr"></a>MTR のサンプル アプリケーション
<a name="xl2007xllsdk_threadsafe"> </a>

���[�N�V�[�g����G�N�X�|�[�g���� XLL �́AExcel �̃}���`�X���b�h�Čv�Z (MTR) �𗘗p�ł��܂� (�Y����������A�X���b�h �Z�[�t�łȂ��A�N�V��������s����K�v���Ȃ��ꍇ)�B����ɂ��AExcel �̓u�b�N��\�Ȍ���Z���ԂɍČv�Z�ł���悤�ɂȂ邽�߁A������A�v���P�[�V�����ɂƂ��Ė]�܂�����ԂɂȂ�܂��B
  
特に、期待される結果を得るために外部プロセスを呼び出すユーザー定義関数 (UDF) を呼び出しているブックの再計算時間には、MTR が非常に大きく影響します。 具体的に、多数の要求を同時に処理できるリモート サーバーを呼び出している UDF と、その関数の呼び出しを多数含んでいるブックについて考えてみましょう。 ブックの再計算がシングル スレッドの場合、それぞれの UDF の呼び出し、つまりリモート サーバーの呼び出しは、後続の呼び出しの前に完了している必要があります。 これでは、一度に多数の呼び出しを処理できるというサーバーの能力が無駄になります。 ブックの再計算がマルチスレッドの場合、Excel は複数の呼び出しを同時に行うことも、間断なく行うこともできます。
  
�T�[�o�[�Ɠ����� (���̐��� N �Ƃ���) �̃X���b�h��g�p����悤�� Excel ���\������Ă��āA�u�b�N�̈ˑ��W�c���[�̃g�|���W�ɂ��̗]�n������A���v�̍Čv�Z���Ԃ̓V���O�� �X���b�h�̌v�Z���Ԃ� 1/N �߂��܂ŒZ�k�����\��������܂��B����́A�u�b�N����s���Ă���N���C�A���g �R���s���[�^�[���v���Z�b�T�� 1 �������ڂ��Ă���ꍇ�ɂ���Ă͂܂�\��������܂��B���ɁA�T�[�o�[�̌Ăяo���ɂ����鎞�Ԃ��A�T�[�o�[�ŌĂяo����������鎞�Ԃ���Z���ꍇ�ɓ��Ă͂܂�܂��B 
  
�ǉ��̃X���b�h�ɂ́A���ꂼ��ɃI�y���[�e�B���O �V�X�e���̃I�[�o�[�w�b�h�����݂��܂��B���̂��߁A����̃u�b�N�Ɠ���̃T�[�o�[����уN���C�A���g �R���s���[�^�[�ɂ��āA���炩�̎����� Excel �ɐݒ肷��œK�ȃX���b�h���������K�v������܂��B 
  
���Ƃ��AExcel ����s���Ă���V���O�� �v���Z�b�T�̃R���s���[�^�[�ƁA1,000 �̃Z����܂�ł���u�b�N�ɂ��čl���Ă݂܂��傤�B����́AUDF ��Ăяo���A���� UDF �� 1 �ȏ�̃����[�g �T�[�o�[��Ăяo���܂��B1,000 �̃Z�������݂Ɉˑ����Ă��Ȃ��Ɖ��肷��ƁAExcel �͌㑱�̌Ăяo������s���邽�߂ɌĂяo���̊�����ҋ@����K�v�͂���܂��� (���̐���́A���̗�ɉe����^���邱�ƂȂ��A������x�̊ɘa���\�ł�)�B�T�[�o�[�� 100 ���̗v���̓����������\�ŁAExcel �� 100 �X���b�h��g�p����悤�ɍ\������Ă���ƁA���s���Ԃ� 1 �X���b�h�݂̂�g�p�����ꍇ�� 1/100 �߂��ɂ܂ŒZ�k�ł��܂��BExcel ���e�X���b�h�ɃZ������蓖�Ă邽�߂ɂ�����I�[�o�[�w�b�h�ƁA�I�y���[�e�B���O �V�X�e���� 100 �X���b�h��Ǘ����邽�߂ɂ�����I�[�o�[�w�b�h�ɂ��A���ۂɂ́A����قǂ܂ł̎��ԒZ�k�ɂ͂Ȃ�܂���B�܂��A�T�[�o�[�̃X�P�[�����O���K�؂ł���A100 ���̃^�X�N�̓���������˗����Ă�ʂ̃^�X�N�̊������Ԃɑ傫�ȉe�����Ȃ��Ƃ������Ƃ�A�ÖٓI�ɉ��肵�Ă��܂��B
  
この技法が大きなメリットになる実用的アプリケーションとして、モンテカルロ法など、小さなタスクに分割して複数のサーバーに依頼できる数値集約型のタスクが挙げられます。
  
## <a name="excel-services-considerations"></a>Excel Services の考慮事項
<a name="xl2007xllsdk_threadsafe"> </a>

Excel Services �́A�T�[�o�[�ł� Excel �X�v���b�h�V�[�g�̓ǂݍ��݁A�v�Z�A����у����_�����O��T�|�[�g���܂��B���[�U�[�́A�W���̃u���E�U �c�[����g�p���āA�X�v���b�h�V�[�g�ɃA�N�Z�X���đΘb�������s�ł���悤�ɂȂ�܂��B
  
Excel Services �� UDF �́AMicrosoft .NET Framework �̃}�l�[�W �R�[�h��g�p���č쐬��, .NET �A�Z���u����ʂ��Ďg�p�\�ɂȂ�܂��BXLL �́AExcel Services �ł̓T�|�[�g����܂���B�}�l�[�W �R�[�h �T�[�o�[ UDF ���\�[�X�́AXLL ��Ăяo���Ă��̋@�\�ɃA�N�Z�X�ł��邽�߁A���[�U�[�̓T�[�o�[�œǂݍ��܂ꂽ�u�b�N�ƃN���C�A���g�œǂݍ��܂ꂽ�u�b�N�œ����@�\��g�p�ł��܂��B
  
���̕��@�� XLL �̊���g�p�ł���悤�ɂ���ɂ́A�����Ɩ߂�l��l�C�e�B�u �f�[�^�^���� .NET Framework �}�l�[�W �f�[�^�^�ɕϊ����� XLL ����Ăяo�� .NET �A�Z���u���ŁA������b�v����K�v������܂��B.NET ���b�p�[�́A�A�N�Z�X�Ώۂ� XLL �����Ƃ� 1 �̃T�[�o�[ UDF ��G�N�X�|�[�g���܂��B�ǉ��̗v���Ƃ��āA���̕��@�ŌĂяo����� XLL ���̓X���b�h �Z�[�t�ł��邱�Ƃ��K�v�ł��BXLL ���͖{���̕��@�� Excel �ɓo�^����Ă��Ȃ����߁A���̊�������I�ɃX���b�h �Z�[�t�ɂ�����@���T�[�o�[�� .NET ���b�p�[�ɂ͂���܂���B����́AXLL �J���҂̐ӔC�ŕۏ؂��܂��B
  
## <a name="see-also"></a>関連項目

- [Excel の再計算](excel-recalculation.md)  
- [Excel のメモリ管理](memory-management-in-excel.md) 
- [Excel での XLL コードへのアクセス](accessing-xll-code-in-excel.md)  
- [Excel プログラミングの概念](excel-programming-concepts.md)  
- [Excel XLL SDK API 関数リファレンス](excel-xll-sdk-api-function-reference.md)

